# リリース自動化ワークフロー
# タグがプッシュされたときに、Windowsインストーラーを自動ビルドし、
# GitHub Releasesに公開するワークフロー

name: Release

# トリガー条件: v*形式のタグがプッシュされたとき（例: v1.0.0）
on:
  push:
    tags:
      - 'v*'

# 権限設定（リリース作成とファイルアップロードに必要）
permissions:
  contents: write

jobs:
  release:
    # Windows環境で実行（Electronアプリのビルドに必要）
    runs-on: windows-latest

    steps:
      # リポジトリのコードをチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4

      # Node.js環境のセットアップ（バージョン20を使用）
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      # 依存関係のインストール（package-lock.jsonを使用した確実なインストール）
      - name: Install dependencies
        run: npm ci

      # アプリケーションのビルド（TypeScriptのコンパイル等）
      - name: Build application
        run: npm run build

      # Windowsインストーラーの作成（electron-builderを使用）
      # 注意: publish: neverで自動公開を無効化（GitHub Actionsで制御するため）
      - name: Build Windows installer
        run: npm run dist -- --publish never

      # タグ名からバージョン番号を抽出（v1.0.0 → 1.0.0）
      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        shell: bash

      # ビルド結果のファイルを確認（デバッグ用）
      - name: List release directory
        run: dir release
        shell: cmd

      # GitHub Releaseの作成と成果物のアップロード
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## 更新内容
            QuickDashLauncher ${{ github.ref_name }} のリリースです。

            ## インストール方法
            
            ### インストーラー版
            `QuickDashLauncher-Setup-${{ steps.get_version.outputs.VERSION }}.exe` をダウンロードして実行してください。
            
            ### ポータブル版
            `QuickDashLauncher-${{ steps.get_version.outputs.VERSION }}.exe` をダウンロードして任意の場所に配置してください。インストール不要で直接実行できます。

            ## 機能
            - Alt+Spaceでグローバルランチャー起動（デフォルト、設定で変更可能）
            - Webサイト、アプリケーション、フォルダへの素早いアクセス
            - フォルダ取込機能でファイル一覧の自動取得
          draft: false
          prerelease: false
          files: |
            release/*.exe
            release/*.exe.blockmap
            release/latest.yml