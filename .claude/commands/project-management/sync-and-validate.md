---
description: "リモート最新取得後、ドキュメント更新・品質チェック・E2Eテスト実施"
allowed-tools: ["Bash", "TodoWrite", "Task", "AskUserQuestion"]
---

# Sync and Validate

メインブランチでリモートの最新を取得し、変更内容に応じてドキュメント更新、品質チェック、E2Eテストを実施するコマンドです。

## 実行内容

1. **現在のブランチ確認**
   ```bash
   !git branch --show-current
   !git status
   ```
   - メインブランチにいることを確認
   - メインブランチでない場合は警告を表示

2. **リモートの最新情報取得**
   ```bash
   !git fetch origin
   ```

3. **ローカルブランチの更新**
   ```bash
   !git pull origin main
   ```

4. **変更内容の確認**
   ```bash
   !git log --oneline -10
   !git log -5 --pretty=format:"%h - %s (%an, %ar)" --stat
   ```
   - 最新のコミット履歴を表示
   - どのような変更があったか確認

5. **ドキュメント更新チェック**
   - 変更内容を分析し、ドキュメント更新が必要かユーザーに確認
   - 必要な場合は `documentation-updater` サブエージェントを実行

6. **品質チェック実行**
   - `quality-checker` サブエージェントを実行
   - TypeScript型チェック、ESLint、コード複雑度、命名規則などを確認

7. **E2Eテスト実行**
   - `e2e-test-runner` サブエージェントを実行
   - テスト失敗時は詳細分析と修正案を提供

## 使用方法

### 基本的な使用
```
/sync-and-validate
```

メインブランチでリモートの最新を取得し、必要な検証を実施します。

## 動作フロー

```
現在のブランチを確認
    ↓
mainブランチ？
    ↓YES → リモート最新取得 → ローカル更新 → 変更内容確認
    ↓NO  → 警告表示（mainブランチで実行することを推奨）
             ↓
        ユーザーに継続確認
             ↓
        継続する？
             ↓YES → リモート最新取得 → ローカル更新 → 変更内容確認
             ↓NO  → 処理中断

変更内容確認
    ↓
ドキュメント更新が必要？
    ↓YES → documentation-updaterサブエージェント実行
    ↓NO  → スキップ
    ↓
品質チェック実行（quality-checker）
    ↓
E2Eテスト実行（e2e-test-runner）
    ↓
完了
```

## 実行ステップ詳細

### Step 1: ブランチ確認
現在のブランチがmainであることを確認します。mainブランチでない場合は：
- 警告メッセージを表示
- ユーザーに継続するかどうか確認
- 継続する場合は現在のブランチで処理を続行

### Step 2: リモート最新取得
```bash
git fetch origin
```
リモートリポジトリの最新情報を取得します。

### Step 3: ローカル更新
```bash
git pull origin main
```
ローカルのmainブランチをリモートの最新に更新します。

### Step 4: 変更内容確認
最新のコミット履歴を表示し、どのような変更があったかを確認します：
- 最近の10件のコミットをワンライン形式で表示
- 最近の5件のコミットを詳細（統計情報付き）で表示

### Step 5: ドキュメント更新チェック
変更内容を分析し、以下の場合にドキュメント更新を提案：
- 新機能の追加（`feat:` プレフィックス）
- UI変更（画面仕様書の更新が必要）
- 設定変更（設定ドキュメントの更新が必要）
- アーキテクチャ変更（アーキテクチャドキュメントの更新が必要）

ドキュメント更新が必要な場合：
```
Task tool with subagent_type="documentation-updater"
```

### Step 6: 品質チェック
コード品質を総合的にチェック：
```
Task tool with subagent_type="quality-checker"
```

以下の項目を自動チェック：
- TypeScript型チェック
- ESLintルール
- コード複雑度
- 命名規則
- 重複コード
- ドキュメント不足
- セキュリティリスク

### Step 7: E2Eテスト実行
E2Eテストを実行し、失敗した場合は詳細分析：
```
Task tool with subagent_type="e2e-test-runner"
```

以下の項目を実行：
- Playwright E2Eテストの実行
- テスト失敗時の詳細分析
- スクリーンショット・トレース解析
- 失敗原因の特定と修正案の提示

## 例

### パターン1: mainブランチで実行（通常）
```bash
$ git branch --show-current
main

$ /sync-and-validate
# → リモート最新取得
# → ローカル更新
# → 変更内容確認
# → ドキュメント更新チェック
# → 品質チェック実行
# → E2Eテスト実行
# → 完了
```

### パターン2: 作業ブランチで実行（警告付き）
```bash
$ git branch --show-current
feature/new-feature

$ /sync-and-validate
# → 警告: mainブランチでない
# → 継続確認
# → ユーザーが継続を選択
# → 現在のブランチで処理を続行
```

### パターン3: 変更がない場合
```bash
$ /sync-and-validate
# → リモート最新取得
# → Already up to date.
# → 変更なし
# → 品質チェックとE2Eテストのみ実行
```

## 安全性チェック

このコマンドは以下の安全性チェックを実行します：
- 現在のブランチ名の確認
- mainブランチでない場合は警告
- 未コミットの変更がある場合は警告
- リモートとの同期状況の確認
- マージコンフリクトの検出

## 事前要件

- 現在のディレクトリがGitリポジトリである
- リモートリポジトリ `origin` が設定されている
- GitHub CLI (`gh`) がインストール・認証済みである（E2Eテスト実行に必要）
- npm依存関係がインストール済みである

## サブエージェント詳細

### documentation-updater
詳細: `.claude/agents/documentation-updater.md`

機能：
- 変更内容の分析
- 関連ドキュメントの特定
- 複数ドキュメントの一括更新
- ドキュメント間の整合性確認

### quality-checker
詳細: `.claude/agents/quality-checker.md`

機能：
- TypeScript型チェック・ESLint実行
- コード複雑度・命名規則・重複コードの検出
- セキュリティリスクの確認
- プロジェクト固有の品質基準チェック
- 優先度付きレポート生成

### e2e-test-runner
詳細: `.claude/agents/e2e-test-runner.md`

機能：
- Playwright E2Eテストの実行
- テスト失敗時の詳細分析（スクリーンショット・トレース解析）
- 失敗原因の特定と修正案の提示
- デバッグ推奨アクションの提供
- 構造化されたテストレポート生成

## 注意事項

### 実行前の確認
- **必ずmainブランチで実行することを推奨**
- 未コミットの変更がある場合は事前にコミットまたはスタッシュ
- リモートリポジトリとの同期を確認

### 実行中の確認
- ドキュメント更新が必要かどうかは慎重に判断
- 品質チェックで検出された問題は優先度を確認して対応
- E2Eテストの失敗は詳細ログを確認して原因を特定

### 実行後の確認
- すべてのテストがパスしていることを確認
- ドキュメントが最新であることを確認
- 品質チェックで検出された問題が解決されていることを確認

## トラブルシューティング

### エラー: "Your local changes to the following files would be overwritten by merge"
未コミットの変更があります。コミットまたはスタッシュしてから実行してください：
```bash
# 変更をコミット
git add .
git commit -m "WIP: 作業中の変更"

# または、変更をスタッシュ
git stash
```

### エラー: "CONFLICT (content): Merge conflict in ..."
マージコンフリクトが発生しました。手動で解決してください：
```bash
# コンフリクトを解決
# エディタでコンフリクトファイルを編集

# 解決後
git add .
git commit
```

### エラー: "fatal: not a git repository"
現在のディレクトリがGitリポジトリではありません。リポジトリのルートディレクトリで実行してください。

### サブエージェントが実行されない
サブエージェントの設定を確認してください：
- `.claude/agents/documentation-updater.md`
- `.claude/agents/quality-checker.md`
- `.claude/agents/e2e-test-runner.md`

## カスタマイズ

このコマンドをカスタマイズしたい場合は、このファイルを編集してください。

### サブエージェントの追加・削除
- ドキュメント更新チェックをスキップ
- 品質チェックのみ実行
- E2Eテストのみ実行
- カスタムサブエージェントの追加

### 実行条件の変更
- mainブランチ以外でも警告なしで実行
- 特定のブランチでのみ実行
- 特定のコミットパターンでのみドキュメント更新を実行

### 通知・レポートの追加
- Slack通知の追加
- メールレポートの送信
- カスタムレポートの生成
