# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

QuickDashLauncherは、グローバルホットキー（Ctrl+Alt+W）でWebサイト、アプリケーション、フォルダ、ファイルに素早くアクセスできるWindows用ランチャーアプリケーション（Electron + React + TypeScript）です。

## ビルドコマンド

```bash
npm install              # 依存関係のインストール
npm run dev             # 開発モード（Viteデベロップメントサーバー、ホットリロード付き）
npm run build           # 全コンポーネントのビルド（Vite使用）
npm run preview         # ビルド済みアプリケーションのプレビュー
npm run start           # ビルドして実行
npm run dist            # Windowsインストーラーの作成
```

### WSL2環境でのビルド

WSL2環境からビルドするときは、Windows上でビルドさせるために、PowerShellを使ってください：

```bash
powershell.exe -Command "npm run build"
powershell.exe -Command "npm run dist"
```

## アーキテクチャ

### プロセス構造
- **メインプロセス** (`src/main/main.ts`): システム操作、ウィンドウ管理、IPCを処理するElectronメインプロセス
- **レンダラープロセス** (`src/renderer/`): UIのためのReactアプリケーション
- **プリロードスクリプト** (`src/main/preload.ts`): レンダラーに限定的なAPIを公開するセキュアブリッジ
- **共通型定義** (`src/common/types.ts`): プロセス間で共有される型定義

### IPCハンドラー構造
IPCハンドラーは機能ごとに分離（`src/main/ipc/`）:
- `configHandlers.ts`: 設定フォルダーへのアクセス
- `dataHandlers.ts`: データファイルの読み込み・保存
- `itemHandlers.ts`: アイテムの起動・フォルダー表示
- `iconHandlers.ts`: ファビコン取得・アイコン抽出

### 主要IPCチャンネル
- `get-config-folder`: ユーザーデータディレクトリパスを返す
- `load-data-files`: 全てのdata*.txtファイルを読み込み、パース
- `save-temp-data`: 一時アイテムを保存
- `open-item`: ファイル/URL/アプリを起動
- `open-parent-folder`: エクスプローラーでアイテムを表示
- `fetch-favicon`: ウェブサイトのファビコンをダウンロード
- `extract-icon`: アプリケーションアイコンを抽出
- `extract-custom-uri-icon`: **新機能** カスタムURIスキーマのハンドラーアプリアイコンを抽出
- `extract-file-icon-by-extension`: ファイル拡張子ベースのアイコン抽出
- `load-cached-icons`: キャッシュされたアイコンを一括読み込み

### データフロー
1. メインプロセスが`%APPDATA%/quickdashlauncher/config/`からデータファイルを読み込む
2. パーサーが複数のデータファイルをマージし、重複を削除し、名前順でソート
3. レンダラーがリアルタイムフィルタリングでアイテムを表示
4. ユーザーアクションがシステム操作のためのIPCコールをメインプロセスにトリガー

## 重要な実装詳細

### ウィンドウの動作
- フレームレスウィンドウ（479x506px）常に最前面
- DevToolsが開いていない限りブラー時に非表示
- Ctrl+Alt+Wグローバルホットキーで表示/非表示
- 表示時に検索ボックスが自動クリア＆フォーカス

### データファイル形式
```
// コメント行は//で開始
表示名,URLまたはパス
アプリ名,C:\path\to\app.exe,オプション引数
dir,C:\folder\path  // フォルダから全ショートカットをインポート（未実装）
```

### アイテムタイプの検出
- URL: `://`を含む
- カスタムURI: 非http(s)スキーマ（obsidian://, ms-excel://）
- アプリ: .exe, .bat, .cmd, .com拡張子
- フォルダ: 拡張子なしまたはスラッシュで終わる
- ファイル: その他すべて

### 検索の実装
- 大文字小文字を区別しないインクリメンタルサーチ
- スペース区切りキーワードでAND検索
- 表示名のみでフィルタリング

### アイコン処理

#### 保存先の分離 (2025-07-04更新)
- ファビコン: `%APPDATA%/quickdashlauncher/config/favicons/`
- EXEアイコン: `%APPDATA%/quickdashlauncher/config/icons/`
- カスタムURIアイコン: `%APPDATA%/quickdashlauncher/config/icons/` (uri_[スキーマ]_icon.png形式)
- 拡張子アイコン: `%APPDATA%/quickdashlauncher/config/icons/extensions/`

#### 取得方法
- ウェブサイト: ファビコンをキャッシュ
  - 新しい`FaviconService`クラスでHTMLメタタグを解析し、複数ソースから取得
  - デフォルト64px（高解像度対応）、既存の32pxキャッシュとの互換性維持
  - 詳細は[ファビコン実装仕様](docs/favicon-implementation.md)を参照
- アプリケーション: `extract-file-icon`を使用してアイコン抽出
- カスタムURI: **新機能** (2025-07-04追加)
  - **第1優先**: Windowsレジストリからスキーマハンドラーアプリケーションを検索し、そのアイコンを抽出
  - **第2優先**: ファイル拡張子ベースのアイコン取得（ms-excel:// → .xlsx）
  - **第3優先**: デフォルト絵文字（🔗）
  - 例: `obsidian://` → Obsidianアプリのアイコン、`ms-excel://` → Microsoft Excelのアイコン
- ファイル: ファイル拡張子ベースのアイコン取得
- デフォルト: 絵文字アイコン（📄ファイル、📁フォルダ、🌐ウェブ、⚙️アプリ、🔗カスタムURI）

#### ボタン機能 (2025-07-04更新)
- 🌐 ファビコン取得: すべてのURLアイテムのファビコンを一括取得
- 🎨 全アイコンを抽出: EXE/ファイル/カスタムURIアイテムのアイコンを一括取得（URLを除く）
  - カスタムURIは**レジストリベースのアイコン取得**を優先実行

#### カスタムURIアイコン抽出の技術詳細 (2025-07-04追加)

##### レジストリクエリプロセス
1. **スキーマ検出**: URIから`://`前のスキーマを抽出（例: `obsidian://` → `obsidian`）
2. **レジストリ検索**: 
   ```cmd
   reg query "HKEY_CLASSES_ROOT\[スキーマ]" /ve
   reg query "HKEY_CLASSES_ROOT\[スキーマ]\shell\open\command" /ve
   ```
3. **実行ファイルパス抽出**: コマンドから`"path.exe"`または`path.exe`を抽出
4. **環境変数展開**: `%PROGRAMFILES%`等を実際のパスに変換
5. **ファイル存在確認**: 実行ファイルの存在を確認

##### アイコン抽出とキャッシュ
- **抽出**: `extract-file-icon`ライブラリで32pxアイコンを抽出
- **キャッシュ**: `uri_[スキーマ]_icon.png`として保存
- **読み込み優先順位**: 
  1. キャッシュされたカスタムURIアイコン
  2. 拡張子ベースのアイコン
  3. デフォルト🔗絵文字

##### 対応例
| URIスキーマ | ハンドラーアプリ | アイコン |
|------------|--------------|--------|
| `obsidian://` | Obsidian.exe | Obsidianアプリアイコン |
| `ms-excel://` | EXCEL.EXE | Microsoft Excelアイコン |
| `vscode://` | Code.exe | Visual Studio Codeアイコン |
| `steam://` | steam.exe | Steamアイコン |

## ビルドシステム

Viteベースのビルドシステムを使用:
- **メインプロセス**: CommonJS形式で`dist/main/`に出力
- **プリロードスクリプト**: CommonJS形式で`dist/preload/`に出力
- **レンダラープロセス**: 標準的なViteビルドで`dist/renderer/`に出力
- **開発サーバー**: ポート9000で実行

## 現在の制限事項とTODO

1. **ディレクトリスキャン（dirディレクティブ）未実装** - パース時にスキップ
2. **最小限のエラーハンドリング** - エラーはコンソールにのみログ出力
3. **Windows専用パス** - クロスプラットフォーム非対応
4. **テストフレームワーク未導入** - 手動テストのみ

## デバッグ時の問題

### 白い/空白のウィンドウ
- DevToolsコンソールでエラーを確認（自動的に開く）
- Viteデベロップメントサーバーが起動しているか確認（開発モード時）
- プロダクションモードでindex.htmlパスが正しいか確認

### よくあるビルドの問題
- TypeScript設定の`@common`パスエイリアスがVite設定と一致しているか確認
- ビルド出力が正しいディレクトリ構造になっているか確認
- Electronのファイルパスがビルド/開発モードで適切に処理されているか確認

## テストチェックリスト

1. グローバルホットキー（Ctrl+Alt+W）登録とウィンドウトグル
2. 全キーボードショートカット（Enter、Shift+Enter、矢印、Ctrl、Escape）
3. 単一および複数キーワードでの検索
4. メイン/一時タブの切り替え
5. 異なるアイテムタイプの起動（URL、ファイル、フォルダ、引数付きアプリ）
6. ウェブサイトのファビコン一括取得（🌐ボタン）
7. アプリケーションアイコンの一括抽出（🎨ボタン、URLを除く） 
8. **新機能** カスタムURIアイコンの一括抽出（🎨ボタン）
   - obsidian://, ms-excel://, vscode://等のカスタムURIでレジストリベースのアイコン取得
   - キャッシュ機能（uri_[スキーマ]_icon.png形式）
   - フォールバック機能（レジストリ → 拡張子 → デフォルト絵文字）
9. 一時タブへのアイテム追加
10. システムトレイダブルクリックでの復元
11. URIスキーマ（obsidian://, ms-excel://など）の処理

## 📚 ドキュメント自動更新システム

このプロジェクトでは、開発中に得られた知識を体系的に管理し、既存ドキュメントに反映させるシステムを採用しています。

### 参照すべきドキュメント

作業開始時に必ず以下のドキュメントを確認してください：

- `CLAUDE.md` - プロジェクトの包括的なドキュメント（プロジェクト概要、アーキテクチャ、実装詳細、ビルドシステム、制限事項等）
- `docs/favicon-implementation.md` - ファビコン取得システムの詳細な技術仕様

### 更新ルール

#### 提案タイミング
以下の状況で、ドキュメント更新を提案してください：

1. **エラーや問題を解決した時**
2. **効率的な実装パターンを発見した時**
3. **新しいAPI/ライブラリの使用方法を確立した時**
4. **既存ドキュメントの情報が古い/不正確だと判明した時**
5. **頻繁に参照される情報を発見した時**
6. **コードレビューの修正を終わらせた時**

#### 提案フォーマット
```
💡 ドキュメント更新の提案： [状況の説明]
【更新内容】 [具体的な追加/修正内容]
【更新候補】
[ファイルパス1] - [理由]
[ファイルパス2] - [理由]
新規ファイル作成 - [理由]
どこに追加しますか？（番号を選択 or skip）
```

#### 承認プロセス
1. ユーザーが更新先を選択
2. 実際の更新内容をプレビュー表示
3. ユーザーが最終承認（yes/edit/no）
4. 承認後、ファイルを更新

### 既存ドキュメントとの連携

- 既存の記載形式やスタイルを踏襲すること
- 関連する既存内容がある場合は参照を明記すること
- 日付（YYYY-MM-DD形式）を含めて更新履歴を残すこと

### 重要な制約

1. **ユーザーの承認なしにファイルを更新しない**
2. **既存の内容を削除・変更せず、追加のみ行う**
3. **機密情報（APIキー、パスワード等）は記録しない**
4. **プロジェクトの慣習やスタイルガイドに従う**

### ドキュメントの分割管理

CLAUDE.mdが肥大化することを防ぐため、以下の基準で適切にファイルを分割してください：

- **100行を超えた場合**: 関連する内容を別ファイルに分離することを提案
- **推奨される分割方法**:
  - `.cursor/rules/update-system.md` - 更新システムのルール
  - `.cursor/rules/project-specific.md` - プロジェクト固有の設定
  - `.cursor/rules/references.md` - 参照すべきドキュメントのリスト
- **CLAUDE.mdには概要とリンクのみ残す**: 詳細は個別ファイルへ