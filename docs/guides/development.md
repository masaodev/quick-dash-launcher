# 開発ガイド

## 重要な実装詳細

### ウィンドウの動作
- フレームレスウィンドウ（479x506px）常に最前面
- DevToolsが開いていない限りブラー時に非表示（固定化時・編集モード時は例外）
- Ctrl+Alt+Wグローバルホットキーで表示/非表示
- 表示時に検索ボックスが自動クリア＆フォーカス
- 📌ボタンでウィンドウ固定化可能（固定中はフォーカスアウトしても非表示にならない）
- 編集モード時のウィンドウ自動拡大（1000x700px）と復元機能

### データファイル形式
```
// コメント行は//で開始
表示名,URLまたはパス
アプリ名,C:\path\to\app.exe,オプション引数
dir,C:\folder\path  // フォルダからファイル・フォルダをインポート
アプリ名,C:\path\to\shortcut.lnk  // 直接指定されたショートカットも自動解析
```

### アイテムタイプの検出
- URL: `://`を含む
- カスタムURI: 非http(s)スキーマ（obsidian://, ms-excel://）
- アプリ: .exe, .bat, .cmd, .com, .lnk拡張子
- フォルダ: 拡張子なしまたはスラッシュで終わる
- ファイル: その他すべて

### 検索の実装
- 大文字小文字を区別しないインクリメンタルサーチ
- スペース区切りキーワードでAND検索
- 表示名のみでフィルタリング

## コード品質向上のガイドライン

### リファクタリングの原則
1. **DRY（Don't Repeat Yourself）**: 同じロジックの重複を避ける
2. **単一責任の原則**: 1つの関数は1つの責任のみ持つ
3. **関数の小型化**: 理解しやすいサイズに関数を分割
4. **命名の明確化**: 関数名と変数名で処理内容を明確に表現

### 共通処理の抽出手順
1. **重複コードの特定**: 同様の処理が複数箇所にないか定期的に確認
2. **共通部分の抽出**: 重複している処理を独立した関数として分離
3. **関数の統合**: 抽出した共通関数を各箇所で使用するよう修正
4. **動作確認**: ビルドとテストで機能が維持されることを検証

### パフォーマンス最適化
- **バンドルサイズ**: 不要なコードの削除でアプリケーションサイズを最適化
- **処理の一貫性**: 同じデータに対して常に同じ処理を適用
- **エラーハンドリング**: 1箇所での修正が全体に反映される設計

## 実装パターンとベストプラクティス

### Electronアプリケーション パターン

#### IPCハンドラーの構造化
- 機能ごとにハンドラーを分離（`src/main/ipc/`）
- 各ハンドラーは単一責任の原則に従う
- 型安全性のため`src/common/types.ts`で共有型を定義

#### プロセス間通信のベストプラクティス
```typescript
// メインプロセス側
ipcMain.handle('channel-name', async (event, args) => {
  try {
    // 処理
    return { success: true, data: result };
  } catch (error) {
    console.error('Error in channel-name:', error);
    return { success: false, error: error.message };
  }
});

// レンダラー側（preload経由）
const result = await window.api.channelName(args);
```

#### ファイルパスの処理
- 開発/本番環境の違いを考慮
- `app.isPackaged`を使用して環境を判定
- パスは常に絶対パスで処理

### React + TypeScript パターン

#### 状態管理
- 小規模な状態は`useState`で管理
- グローバル状態は必要に応じてContextを使用

#### 型定義
- インターフェースは`I`プレフィックスを使用
- 型は`src/common/types.ts`で一元管理

### CSS開発パターン

#### デザインシステムの使用
QuickDashLauncherではCSS変数ベースの統一されたデザインシステムを採用しています。

**基本ルール:**
- ハードコード値の使用禁止（色、サイズ、間隔など）
- 必ずvariables.cssで定義された変数を使用
- 共通クラス（common.css）を積極的に活用

**新しいコンポーネントのスタイル作成手順:**
1. `src/renderer/styles/components/`に新しいCSSファイルを作成
2. CSS変数のみを使用してスタイルを記述
3. 共通クラスで対応できる部分は再利用
4. コンポーネントファイルでCSSをインポート

```css
/* 良い例 */
.my-component {
  padding: var(--spacing-lg);
  background-color: var(--bg-section);
  border: var(--border-light);
  color: var(--text-primary);
}

/* 悪い例 */
.my-component {
  padding: 16px;
  background-color: #f9f9f9;
  border: 1px solid #e0e0e0;
  color: #333;
}
```

**詳細情報:**
- [CSSデザインシステム](../features/css-design-system.md) - 完全なガイドラインと使用方法

### パフォーマンス最適化パターン

#### アイコンのキャッシュ
- ファビコンは`%APPDATA%/quickdashlauncher/config/favicons/`にキャッシュ
- ダウンロード前にキャッシュの存在を確認

#### 検索の最適化
- 大文字小文字を区別しないインクリメンタルサーチ
- フィルタリングはレンダラー側でリアルタイム実行

## UIコンポーネント構造

### 主要コンポーネント
- **App.tsx**: メインアプリケーションコンポーネント
- **SearchBox.tsx**: 検索入力フィールド
- **ActionButtons.tsx**: アクションボタンコンテナ
- **SettingsDropdown.tsx**: 設定関連機能のドロップダウンメニュー
- **TabControl.tsx**: メイン/一時タブの切り替え
- **ItemList.tsx**: アイテムリスト表示
- **RegisterModal.tsx**: ドラッグ&ドロップ登録用モーダル
- **EditableRawItemList.tsx**: 編集モード用のデータ編集テーブル
  - パスと引数列でパス＋引数を統合表示・編集
  - アイテム行：パス＋引数の組み合わせ（例：`notepad.exe`, `https://github.com/`）
  - フォルダ取込ディレクティブ：フォルダパス＋オプション（例：`C:\Users\Documents filter:*.txt`）
  - 編集時の自動CSV形式変換機能

### 設定メニュー
設定関連機能は⚙ボタンクリックで表示されるドロップダウンメニューに集約:
- 📁 設定フォルダを開く
- 📄 設定ファイルを開く
- 📋 JSON出力（クリップボードにコピー）
- ─── (区切り線)
- 🚪 アプリを終了

## 現在の制限事項とTODO

1. **最小限のエラーハンドリング** - エラーはコンソールにのみログ出力
2. **Windows専用パス** - クロスプラットフォーム非対応
3. **テストフレームワーク未導入** - 手動テストのみ

## デバッグ時の問題

### 白い/空白のウィンドウ
- DevToolsコンソールでエラーを確認（自動的に開く）
- Viteデベロップメントサーバーが起動しているか確認（開発モード時）
- プロダクションモードでindex.htmlパスが正しいか確認

### よくあるビルドの問題
- TypeScript設定の`@common`パスエイリアスがVite設定と一致しているか確認
- ビルド出力が正しいディレクトリ構造になっているか確認
- Electronのファイルパスがビルド/開発モードで適切に処理されているか確認

## ファイル入出力処理

### 改行コードの処理
- **ファイル保存時**: 常にCRLF（`\r\n`）で統一
- **ファイル読み込み時**: 正規表現`/\r\n|\n|\r/`で分割し、CRLF、LF、CRのいずれにも対応
- **対象関数**:
  - `loadRawDataFiles`: 生データファイルの読み込み
  - `saveRawDataFiles`: 生データファイルの保存（CRLF統一）
  - `loadDataFiles`: フォルダ取込ディレクティブ展開時の読み込み
  - `registerItems`: 新規アイテム登録時の保存

### CSVフォーマットの処理
- **アイテム行**: `名前,パス[,引数][,元パス]`
  - 引数と元パスは省略可能
  - セル編集時は必要なフィールドのみ出力（末尾の無駄なカンマを防止）
- **フォルダ取込ディレクティブ**: `dir,パス[,オプション...]`
  - オプションはカンマ区切りで複数指定可能

## 関連ドキュメント

- [編集モード詳細ガイド](../features/edit-mode.md) - 編集モードの操作方法と技術実装
- [CSSデザインシステム](../features/css-design-system.md) - 統一されたスタイル管理システム
- [ビルドとデプロイ](build-and-deploy.md) - ビルドシステムと配布方法
- [テストチェックリスト](testing.md) - 手動テストの手順
- [アイコンシステム](../features/icon-system.md) - アイコン取得・管理システム
- [フォルダ取込ディレクティブ](../features/dir-directive.md) - フォルダ内容のインポート機能