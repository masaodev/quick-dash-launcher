# 初回設定画面仕様書

## 関連ドキュメント

- [画面一覧](./README.md) - 全画面構成の概要
- [メインウィンドウ](./main-window.md) - メイン画面の詳細
- [アプリケーション設定](./admin-window.md#7-設定機能の詳細) - 設定方法とトラブルシューティング

## 1. 概要

初回設定画面は、QuickDashLauncherを初めて起動した際に表示される、起動ホットキーの初期設定画面です。ユーザーが最初にアプリケーションを起動したときにのみ表示され、設定完了後は通常のメインウィンドウが表示されます。

### 主要機能
- **ホットキー設定**: 起動ホットキーのカスタマイズ（デフォルト: Alt+Space）
- **自動起動設定**: Windows起動時の自動起動の有効化（デフォルト: 無効）
- **リアルタイムバリデーション**: ホットキー入力時に使用可能かをリアルタイムチェック
- **強制設定**: ESCキーやフォーカス喪失では閉じられず、設定完了が必須

## 2. 基本情報

| 項目 | 内容 |
|------|------|
| **ファイル名** | `src/renderer/components/SetupFirstLaunch.tsx` |
| **スタイルファイル** | `src/renderer/styles/components/SetupFirstLaunch.css` |
| **コンポーネント名** | `SetupFirstLaunch` |
| **表示条件** | `hotkey`が空文字列または未設定の場合 |
| **画面タイプ** | フルスクリーン初期設定画面 |
| **親コンポーネント** | `App.tsx` |
| **自動表示タイミング** | スプラッシュウィンドウ終了後 |

## 3. 画面項目一覧

| エリア | 項目名 | 内容・説明 | 表示条件 | 機能詳細 |
|--------|--------|------------|----------|----------|
| **ヘッダー** | タイトル | 「QuickDash Launcherへようこそ」 | 常時表示 | - |
| **ヘッダー** | 説明文 | 起動ホットキー設定の説明 | 常時表示 | - |
| **メイン** | ホットキー入力欄 | 起動ホットキーの設定（デフォルト: Alt+Space） | 常時表示 | [4.1](#41-ホットキー入力欄への入力) |
| **メイン** | バリデーションエラー | ホットキーが無効な場合のエラーメッセージ | バリデーション失敗時 | [4.1](#41-ホットキー入力欄への入力) |
| **メイン** | ヒントテキスト | 設定例や修飾キーの説明 | 常時表示 | - |
| **メイン** | 自動起動チェックボックス | 起動時の自動実行設定（デフォルト: 無効） | 常時表示 | [4.5](#45-自動起動設定の変更) |
| **メイン** | 自動起動ヒント | 自動起動機能の説明テキスト | 常時表示 | - |
| **フッター** | 設定完了ボタン | 入力したホットキーで設定を保存 | 常時表示 | [4.2](#42-設定を完了ボタン押下) |

## 4. アクション一覧

| No | アクション名 | トリガー | 主な処理内容 | 詳細 |
|----|------------|---------|------------|------|
| 4.1 | ホットキー入力欄への入力 | キー押下 | ホットキーのリアルタイムバリデーション | [詳細](#41-ホットキー入力欄への入力) |
| 4.2 | 「設定を完了」ボタン押下 | ボタンクリック | 入力したホットキーで設定完了 | [詳細](#42-設定を完了ボタン押下) |
| 4.3 | 初回起動チェック | アプリケーション起動時 | 初回設定画面の表示判定 | [詳細](#43-初回起動チェック) |
| 4.4 | ESCキー/フォーカス喪失 | キー押下/フォーカス喪失 | 無視（閉じない） | [詳細](#44-escキーフォーカス喪失の無視) |
| 4.5 | 自動起動設定の変更 | チェックボックスクリック | 自動起動の有効/無効を切り替え | [詳細](#45-自動起動設定の変更) |

## 5. 機能詳細

### 4.1. ホットキー入力欄への入力

#### アクション
- ホットキー入力欄をクリックし、キー組み合わせを入力

#### 処理フロー
1. ホットキー入力コンポーネントでキー入力を受け付け
2. リアルタイムでホットキー文字列を生成（例: `Ctrl+Alt+Q`）
3. バリデーションを実行（メインプロセス側でIPC経由）:
   - 空チェック
   - 形式チェック（正規表現パターン）
   - 修飾キーの有無チェック
4. バリデーション結果を表示:
   - 有効な場合: エラー表示なし、「設定を完了」ボタン有効化
   - 無効な場合: エラーメッセージ表示、「設定を完了」ボタン無効化

#### バリデーション詳細

**IPCチャンネル**: `settings:validate-hotkey`

| チェック項目 | 説明 | エラーメッセージ |
|-------------|------|-----------------|
| 空チェック | ホットキーが指定されているか | 「ホットキーが指定されていません」 |
| 形式チェック | 正規表現パターンに一致するか | 「ホットキーの形式が正しくありません」 |
| 修飾キーチェック | Ctrl/Alt/Shift等が含まれているか | 「修飾キー（Ctrl、Alt、Shift等）が必要です」 |

**有効なキーパターン**:
- 修飾キー: `Ctrl`, `Alt`, `Shift`, `CmdOrCtrl`, `Command`, `Cmd`
- 通常キー: `A-Z`, `0-9`, `Space`, `Enter`, `Tab`, `Escape`, `Delete`, `Backspace`, `F1-F12`

#### バリデーション例
- **成功**: `Ctrl+Alt+Q` → 「設定を完了」ボタンが有効
- **失敗**: `Q` → 「修飾キーが必要です」エラー表示

#### デフォルト値
- 初期表示: `Alt+Space`

### 4.2. 「設定を完了」ボタン押下

#### アクション
- 「設定を完了」ボタンをクリック

#### 処理フロー
1. ホットキーのバリデーション状態を確認
2. バリデーション失敗時は処理を中止
3. バリデーション成功時:
   - 入力されたホットキーと自動起動設定を設定ファイルに保存
   - 起動ホットキーを即座に登録
   - 自動起動設定を適用（AutoLaunchServiceによる）
   - 初回起動モードを終了
4. 初回設定画面を非表示
5. メインウィンドウに遷移

#### バリデーションチェック
- バリデーション失敗時はボタンが無効化されるため、通常は実行されない
- 念のため、ボタン押下時にも再度バリデーション確認

#### エラーハンドリング
- 設定保存失敗時: アラート「設定の保存に失敗しました。」

### 4.3. 初回起動チェック

#### アクション
- アプリケーション起動時に自動判定

#### 処理フロー
1. 設定サービスを初期化
2. ホットキー設定を取得
3. ホットキーが空または未設定の場合:
   - 初回起動モードを有効化
   - 初回設定画面を表示
4. ホットキーに値がある場合:
   - 通常モードで起動
   - メインウィンドウを表示

#### 表示判定
- **初回起動**: ホットキーが空または未設定 → 初回設定画面
- **2回目以降**: ホットキーに値がある → メインウィンドウ

### 4.4. ESCキー/フォーカス喪失の無視

#### アクション
- ESCキーを押下、またはウィンドウからフォーカスが外れる

#### 処理フロー
1. メインプロセスで初回起動モードが有効かチェック
2. 初回起動モードの場合:
   - ESCキーによるウィンドウの非表示を無視
   - フォーカス喪失によるウィンドウの非表示を無視
3. 通常モードの場合:
   - 通常通りウィンドウを非表示

#### 目的
- ユーザーが初回設定を完了するまで、誤ってウィンドウを閉じないようにする
- 設定完了を強制することで、アプリケーションの正常な動作を保証

### 4.5. 自動起動設定の変更

#### アクション
- 自動起動チェックボックスをクリック

#### 処理フロー
1. チェックボックスの状態を切り替え（チェック/未チェック）
2. 状態をローカルステートに保存
3. 完了ボタン押下時に設定ファイルに反映

#### デフォルト値
- 初期表示: 無効（未チェック）

#### 設定の反映
- 完了ボタン押下時に`settings.json`の`autoLaunch`に保存
- `AutoLaunchService`がWindowsスタートアップフォルダにショートカットを作成/削除
- 設定タブでいつでも変更可能

#### 注意事項
- 自動起動を有効にすると、Windowsログイン時にアプリが自動的に起動します
- 無効にしたい場合は、設定タブから変更できます

## 6. データフロー

### 初回起動時
1. アプリケーション起動
2. 設定ファイルからホットキーを読み込み
3. ホットキーが空の場合 → 初回起動モード有効化
4. スプラッシュウィンドウを表示後、初回設定画面を表示

### 設定完了時
1. 「設定を完了」ボタン押下
2. ホットキーと自動起動設定を設定ファイルに保存
3. 起動ホットキーを登録
4. 自動起動設定を適用（スタートアップフォルダへのショートカット作成/削除）
5. 初回起動モードを終了
6. メインウィンドウを表示

## 7. UI仕様

### レイアウト
- **中央配置**: 全体が画面中央に配置
- **シンプルデザイン**: タイトル、説明、入力欄、ボタンの縦並びレイアウト
- **ウィンドウサイズ**: 初回起動時は700x600で表示（通常のメインウィンドウより大きめ）

### スタイル
- **背景色**: メインウィンドウと同一
- **フォント**: システムフォント
- **ボタン配置**: 下部中央に「設定を完了」ボタン1つ

### スタイルファイル
- `src/renderer/styles/components/SetupFirstLaunch.css`

## 8. 関連コンポーネント

### HotkeyInput
- **用途**: ホットキーの入力とバリデーション
- **再利用**: 管理ウィンドウの設定タブでも使用
- **機能**: キー入力、リアルタイムバリデーション、エラー表示

### メインアプリケーション
- **役割**: 初回起動判定と画面切り替え
- **状態管理**: 初回起動フラグ
- **条件分岐**: 初回設定画面とメインウィンドウの表示制御

## 9. 設定値

### デフォルトホットキー
- `Alt+Space`

### デフォルト自動起動設定
- `false`（無効）

### 設定ファイル
- **パス**: `%APPDATA%/quick-dash-launcher/config/settings.json`
- **キー**:
  - `hotkey`: ホットキー設定（デフォルト: `Alt+Space`）
  - `autoLaunch`: 自動起動設定（デフォルト: `false`）

## 10. トラブルシューティング

### 初回設定画面が表示されない
- 設定ファイルの`hotkey`に値が設定されている
- 手動で`hotkey`を空文字列（`""`）に変更すると再表示可能

### 初回設定画面が毎回表示される
- 設定ファイルの`hotkey`が空になっている
- 初回設定を完了するか、手動で`hotkey`に値を設定してください

### ホットキーが保存されない
- バリデーションエラーを確認
- 設定ファイルへの書き込み権限を確認
- ログファイルでエラーメッセージを確認

### ボタンが無効化されている
- ホットキーのバリデーション失敗
- 有効なキー組み合わせを入力してください
- 修飾キー（Ctrl、Alt、Shift）を含める必要があります

### ESCキーで閉じられない
- 初回設定画面は意図的にESCキーを無視します
- 設定を完了してから通常モードに移行してください
