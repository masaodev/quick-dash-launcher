# ブックマークインポートモーダル仕様書

## 関連ドキュメント

- [画面一覧](./README.md) - 全画面構成の概要
- [メインウィンドウ](./main-window.md) - メイン画面の詳細仕様
- [アイテム管理](./admin-window.md#6-アイテム管理の詳細) - 編集機能の詳細
- [IPC通信](../architecture/ipc-channels.md) - ブラウザ検出・ブックマーク解析API

## 1. 概要

ブックマークインポートモーダルは、ブラウザのブックマークを選択的にインポートするための機能です。編集モード時にブックマークインポートボタンをクリックすることで表示されます。

**キーボードショートカット**: Escapeキーでモーダルを閉じることができます。

### 主要機能
- **ブラウザ直接インポート**: Chrome/Edgeのブックマークを直接読み込み（HTMLエクスポート不要）
- **プロファイル選択**: 複数プロファイルが存在する場合、プロファイルを選択可能
- **HTMLファイルインポート**: 従来通り、HTMLブックマークファイルからもインポート可能
- **ブックマーク一覧表示**: パースされたブックマークをテーブル形式で表示
- **検索・フィルタリング**: 名前またはURLでのリアルタイム検索
- **選択機能**: 個別選択、一括選択、表示中の項目のみ選択
- **インポート実行**: 選択されたブックマークを一時タブデータにインポート

## 2. 基本情報

| 項目 | 内容 |
|------|------|
| **ファイル名** | `src/renderer/components/BookmarkImportModal.tsx` |
| **コンポーネント名** | `BookmarkImportModal` |
| **表示条件** | 編集モードでブックマークインポートボタンクリック時 |
| **モーダルタイプ** | オーバーレイ型モーダル |
| **親画面** | AdminItemManagerView |

## 3. 画面項目一覧

| エリア | 項目名 | 内容・説明 | 表示条件 | 機能詳細 |
|--------|--------|------------|----------|----------|
| **ヘッダー** | タイトル | 「ブラウザのブックマークの追加」 | 常時表示 | - |
| **ヘッダー** | 閉じるボタン | ✕ボタンでモーダルを閉じる | 常時表示 | [4.14. 閉じるボタン押下時](#414-閉じるボタン押下時ヘッダー) |
| **インポート先バー** | インポート先ラベル | 「インポート先:」 | 常時表示 | - |
| **インポート先バー** | インポート先値 | インポート先のグループ/タブ名 | 常時表示 | - |
| **コントロール** | インポート元選択ラベル | 「インポート元を選択:」 | 常時表示 | - |
| **コントロール** | Chromeボタン | Chromeがインストールされている場合は有効 | 常時表示 | [4.1. インポート元選択時](#41-インポート元選択時) |
| **コントロール** | Edgeボタン | Edgeがインストールされている場合は有効 | 常時表示 | [4.1. インポート元選択時](#41-インポート元選択時) |
| **コントロール** | HTMLファイルボタン | 常に有効 | 常時表示 | [4.1. インポート元選択時](#41-インポート元選択時) |
| **コントロール** | ブラウザ検出中表示 | 「ブラウザを検出中...」 | 起動直後（検出中） | - |
| **コントロール** | プロファイルセレクター | プロファイルの選択肢（プロファイルID付き表示名） | Chrome/Edge選択時かつプロファイルが存在する場合 | [4.2. プロファイル選択時](#42-プロファイル選択時) |
| **コントロール** | ブックマークを読み込むボタン | 読み込み中は無効化 | Chrome/Edge選択時かつプロファイルが存在する場合 | [4.3. ブラウザブックマーク読み込み時](#43-ブラウザブックマーク読み込み時) |
| **コントロール** | ファイルを選択ボタン | 「ファイルを選択」<br>読み込み中は無効化 | HTMLファイル選択時 | [4.4. ファイル選択ボタン押下時](#44-ファイル選択ボタン押下時) |
| **コントロール** | ファイル名表示 | 選択されたファイル名を表示 | HTMLファイル選択後 | - |
| **コントロール** | 検索入力欄 | プレースホルダー「名前またはURLで検索...」、クリアボタン付き | ブックマーク読み込み後 | [4.5. 検索入力欄変更時](#45-検索入力欄変更時) |
| **コントロール** | 表示中を選択ボタン | フィルタリングされた項目を全て選択 | ブックマーク読み込み後 | [4.6. 表示中を選択ボタン押下時](#46-表示中を選択ボタン押下時) |
| **コントロール** | 表示中を解除ボタン | フィルタリングされた項目の選択を全て解除 | ブックマーク読み込み後 | [4.7. 表示中を解除ボタン押下時](#47-表示中を解除ボタン押下時) |
| **コントロール** | 全て選択ボタン | 全ブックマークを選択 | ブックマーク読み込み後 | [4.8. 全て選択ボタン押下時](#48-全て選択ボタン押下時) |
| **コントロール** | 全て解除ボタン | 全ブックマークの選択を解除 | ブックマーク読み込み後 | [4.9. 全て解除ボタン押下時](#49-全て解除ボタン押下時) |
| **リスト** | ブックマークテーブル | ブックマーク一覧を表示 | ブックマーク読み込み後 | - |
| **リスト** | チェックボックス列 | 選択用チェックボックス | ブックマーク読み込み後 | [4.10. チェックボックス選択時](#410-チェックボックス選択時) |
| **リスト** | 名前列 | ブックマーク名 | ブックマーク読み込み後 | - |
| **リスト** | URL列 | ブックマークURL | ブックマーク読み込み後 | - |
| **リスト** | 選択行 | 選択された行のスタイル | 行選択時 | - |
| **重複警告** | 警告アイコンとメッセージ | 「{N}件の重複が検出されました」 | 選択中のブックマークに重複が存在する場合 | - |
| **重複警告** | スキップラジオボタン | 「スキップ（重複アイテムはインポートしない）」 | 重複が検出された場合 | [4.11. 重複処理オプション選択時](#411-重複処理オプション選択時) |
| **重複警告** | 上書きラジオボタン | 「上書き（既存アイテムを新しい情報で更新）」 | 重複が検出された場合 | [4.11. 重複処理オプション選択時](#411-重複処理オプション選択時) |
| **フッター** | ステータス情報 | 「{フィルタ後件数}件中{選択件数}件を選択中」<br>検索時は「(全体: {全体件数}件中{全選択件数}件)」も追加 | ブックマーク読み込み後 | - |
| **フッター** | キャンセルボタン | モーダルを閉じる | 常時表示 | [4.12. キャンセルボタン押下時](#412-キャンセルボタン押下時) |
| **フッター** | インポートボタン | 「インポート ({選択件数}件)」<br>選択件数0の場合は無効化 | 常時表示 | [4.13. インポートボタン押下時](#413-インポートボタン押下時) |

## 4. 機能詳細

### 4.1. インポート元選択時

#### 処理フロー
1. インポート元ボタン（Chrome / Edge / HTMLファイル）をクリック
2. `importSource`状態を更新（`'chrome'` / `'edge'` / `'html'`）
3. ブックマーク一覧・選択状態・検索クエリ・ファイル名・プロファイル選択をリセット
4. Chrome / Edge の場合、そのブラウザのプロファイル一覧から最初のプロファイルを自動選択

#### インポート元ボタンの有効/無効
- Chrome・Edgeボタン: `browser.installed`が`true`の場合のみクリック可能。インストールされていない場合はdisabled属性が付与される
- HTMLファイルボタン: 常に有効

#### ブラウザ検出タイミング
- モーダル表示時（`isOpen`が`true`になった時点）に自動的に`detectInstalledBrowsers` IPCを呼び出す
- 検出中は「ブラウザを検出中...」テキストを表示

### 4.2. プロファイル選択時

#### 表示条件
- Chrome または Edge が選択されており、かつそのブラウザのプロファイルが1件以上存在する場合

#### セレクターの表示形式
- 選択肢: `{profile.displayName} ({profile.id})` の形式

#### 処理内容
- セレクターで選択されたプロファイルを`selectedProfile`状態に格納

### 4.3. ブラウザブックマーク読み込み時

#### 実行条件
- `selectedProfile`が選択済みであること

#### 処理フロー
1. **ローディング状態開始**: 「読み込み中...」表示、ボタン無効化
2. **IPCチャンネル呼び出し**: `parse-browser-bookmarks` に`selectedProfile.bookmarkPath`を渡す
3. **ブックマーク読み込み成功時**:
   - 解析結果をリストに表示
   - 選択状態を初期化
   - 件数が0の場合は「ブックマークが見つかりませんでした」情報アラートを表示
4. **エラーハンドリング**: エラーメッセージをアラートで表示（エラーオブジェクトのmessageを優先）
5. **ローディング状態終了**

### 4.4. ファイル選択ボタン押下時

#### 処理フロー
1. **IPCチャンネル呼び出し**: `select-bookmark-file`でファイル選択ダイアログを表示
2. **キャンセル時**: ファイルパスが返らない場合は処理終了
3. **ファイル選択後**:
   - ファイル名（パスの末尾部分）を表示
   - ローディング状態開始
   - `parse-bookmark-file`チャンネルにパスを渡して解析実行
   - 解析結果をリストに表示
   - 選択状態を初期化
4. **エラーハンドリング**: 「ブックマークファイルの読み込みに失敗しました」アラートを表示
5. **ローディング状態終了**

### 4.5. 検索入力欄変更時

#### フィルタリング条件
- **対象フィールド**: ブックマーク名（`displayName`）、ブックマークURL（`url`）
- **検索方式**: 部分一致（大文字小文字区別なし）
- **リアルタイム更新**: 入力と同時にフィルタリング実行
- **クリア機能**: テキスト入力時に「×」ボタンで検索クリア

### 4.6. 表示中を選択ボタン押下時

#### 処理内容
- **対象**: フィルタリング後のアイテム
- **動作**: フィルタ後のアイテムを選択状態に追加（既存の選択は保持）

### 4.7. 表示中を解除ボタン押下時

#### 処理内容
- **対象**: フィルタリング後のアイテム
- **動作**: フィルタ後のアイテムの選択を解除（フィルタ外のアイテムの選択は保持）

### 4.8. 全て選択ボタン押下時

#### 処理内容
- **対象**: 全ブックマーク（フィルタリングに関わらず）
- **動作**: 全アイテムのIDを選択状態に設定（既存の選択を置き換え）

### 4.9. 全て解除ボタン押下時

#### 処理内容
- **対象**: 全ブックマーク
- **動作**: 全アイテムの選択を解除

### 4.10. チェックボックス選択時

#### 処理内容
- **操作**: 単一アイテムのチェックボックスクリック
- **動作**: 選択状態をトグル（選択中なら解除、未選択なら選択）

### 4.11. 重複処理オプション選択時

#### 表示条件
- 選択中のブックマークに既存アイテムとの重複が1件以上検出された場合に警告セクションを表示

#### オプション
| 値 | ラベル | 動作 |
|----|--------|------|
| `skip` | スキップ（重複アイテムはインポートしない） | 重複しているブックマークをインポートから除外 |
| `overwrite` | 上書き（既存アイテムを新しい情報で更新） | 重複アイテムの既存データを上書き |

- デフォルト値: `skip`
- ラジオボタンで排他選択
- 重複検出はリアルタイムで実行（選択状態が変わるたびに再計算）

### 4.12. キャンセルボタン押下時

#### 処理内容
- モーダル内部の状態をリセット（ブックマーク一覧・選択状態・検索クエリ・ファイル名・インポート元・プロファイル・重複処理オプションをすべて初期値に戻す）
- `onClose`コールバックを呼び出してモーダルを閉じる

### 4.13. インポートボタン押下時

#### 実行条件チェック
- 選択されたブックマークが1件以上存在すること

#### エラーハンドリング
- **選択件数0の場合**: 「インポートするブックマークを選択してください」警告アラートを表示

#### インポート処理フロー
1. **選択ブックマーク抽出**: 選択されたブックマークを抽出
2. **インポート実行**: 選択されたブックマークと`duplicateHandling`オプションを`onImport`コールバックに渡す
3. **モーダルを閉じる**: `handleClose`を呼び出し、状態をリセットしてモーダルを閉じる

### 4.14. 閉じるボタン押下時（ヘッダー）

#### 処理内容
- モーダル内部の状態をリセット（[4.12.](#412-キャンセルボタン押下時) と同一）
- `onClose`コールバックを呼び出してモーダルを閉じる

## 5. IPCチャンネル一覧

| チャンネル名 | 定数名 | 方向 | 用途 |
|-------------|--------|------|------|
| `detect-installed-browsers` | `DETECT_INSTALLED_BROWSERS` | renderer → main | インストール済みブラウザ（Chrome/Edge）の検出 |
| `parse-browser-bookmarks` | `PARSE_BROWSER_BOOKMARKS` | renderer → main | ブラウザのブックマークファイル（JSONフォーマット）を解析 |
| `select-bookmark-file` | `SELECT_BOOKMARK_FILE` | renderer → main | HTMLブックマークファイル選択ダイアログを表示 |
| `parse-bookmark-file` | `PARSE_BOOKMARK_FILE` | renderer → main | HTMLブックマークファイルを解析して`SimpleBookmarkItem[]`を返す |

