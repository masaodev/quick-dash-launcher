# ブックマークインポートモーダル仕様書

## 1. 概要

ブックマークインポートモーダルは、HTMLブックマークファイルからブックマークアイテムを選択的にインポートするための機能です。編集モード時にブックマークインポートボタンをクリックすることで表示されます。

## 2. 基本情報

| 項目 | 内容 |
|------|------|
| **ファイル名** | `src/renderer/components/BookmarkImportModal.tsx` |
| **コンポーネント名** | `BookmarkImportModal` |
| **表示条件** | 編集モードでブックマークインポートボタンクリック時 |
| **モーダルタイプ** | オーバーレイ型モーダル |
| **親画面** | EditModeView |

## 3. 機能概要

- **HTMLブックマークファイルの読み込み**: ファイル選択ダイアログで.html/.htmファイルを選択
- **ブックマーク一覧表示**: パースされたブックマークをテーブル形式で表示
- **検索・フィルタリング**: 名前またはURLでのリアルタイム検索
- **選択機能**: 個別選択、一括選択、表示中の項目のみ選択
- **インポート実行**: 選択されたブックマークを一時タブデータにインポート

## 4. UI構成

### 4.1. 画面項目一覧

| エリア | 項目名 | 内容・説明 | 表示条件 | CSSクラス | 機能詳細 |
|--------|--------|------------|----------|-----------|----------|
| **ヘッダー** | タイトル | 「ブックマークをインポート」 | 常時表示 | - | - |
| **ヘッダー** | 閉じるボタン | ✕ボタンでモーダルを閉じる | 常時表示 | - | [5.10. 閉じるボタン押下時](#510-閉じるボタン押下時) |
| **コントロール** | ファイル選択ボタン | 「ファイルを選択」<br>読み込み中は「読み込み中...」に変更 | 常時表示 | - | [5.1. ファイル選択ボタン押下時](#51-ファイル選択ボタン押下時) |
| **コントロール** | ファイル名表示 | 選択されたファイル名を表示 | ファイル選択後 | - | - |
| **コントロール** | 検索入力欄 | プレースホルダー「名前またはURLで検索...」 | ブックマーク読み込み後 | - | [5.2. 検索入力欄変更時](#52-検索入力欄変更時) |
| **コントロール** | 表示中を選択ボタン | フィルタリングされた項目を全て選択 | ブックマーク読み込み後 | - | [5.3. 表示中を選択ボタン押下時](#53-表示中を選択ボタン押下時) |
| **コントロール** | 表示中を解除ボタン | フィルタリングされた項目の選択を全て解除 | ブックマーク読み込み後 | - | [5.4. 表示中を解除ボタン押下時](#54-表示中を解除ボタン押下時) |
| **コントロール** | 全て選択ボタン | 全ブックマークを選択 | ブックマーク読み込み後 | - | [5.5. 全て選択ボタン押下時](#55-全て選択ボタン押下時) |
| **コントロール** | 全て解除ボタン | 全ブックマークの選択を解除 | ブックマーク読み込み後 | - | [5.6. 全て解除ボタン押下時](#56-全て解除ボタン押下時) |
| **リスト** | ブックマークテーブル | ブックマーク一覧を表示 | ブックマーク読み込み後 | `bookmark-table` | - |
| **リスト** | チェックボックス列 | 選択用チェックボックス | ブックマーク読み込み後 | `checkbox-column` | [5.7. チェックボックス選択時](#57-チェックボックス選択時) |
| **リスト** | 名前列 | ブックマーク名 | ブックマーク読み込み後 | `name-column` | - |
| **リスト** | URL列 | ブックマークURL | ブックマーク読み込み後 | `url-column` | - |
| **リスト** | 選択行 | 選択された行のスタイル | 行選択時 | `selected` | - |
| **フッター** | ステータス情報 | 「{フィルタ後件数}件中{選択件数}件を選択中」<br>検索時は「(全体: {全体件数}件中{全選択件数}件)」も追加 | ブックマーク読み込み後 | - | - |
| **フッター** | キャンセルボタン | モーダルを閉じる | 常時表示 | - | [5.9. キャンセルボタン押下時](#59-キャンセルボタン押下時) |
| **フッター** | インポートボタン | 「インポート ({選択件数}件)」<br>選択件数0の場合は無効化 | 常時表示 | - | [5.8. インポートボタン押下時](#58-インポートボタン押下時) |

## 5. 機能詳細

### 5.1. ファイル選択ボタン押下時

#### 処理フロー
1. **ローディング状態開始**: `setLoading(true)`
2. **ファイル選択ダイアログ表示**: `window.electronAPI.selectBookmarkFile()`
   - タイトル: 「ブックマークファイルを選択」
   - フィルター: HTML Files (*.html, *.htm), All Files (*.*)
   - プロパティ: openFile
3. **ファイル選択時処理**:
   - ファイル名を状態に保存: `setFileName(path.basename(filePath))`
   - ブックマーク解析実行: `window.electronAPI.parseBookmarkFile(filePath)`
   - 解析結果を状態に保存: `setBookmarks(parsedBookmarks)`
   - 選択状態初期化: `setSelectedIds(new Set())`、`setSearchQuery('')`
4. **エラーハンドリング**: 
   - コンソールエラー出力 + 「ブックマークファイルの読み込みに失敗しました」アラート表示
5. **ローディング状態終了**: `setLoading(false)` (finally)

#### ブックマーク解析仕様
- **解析対象**: HTMLファイル内の`<A>`タグ
- **正規表現**: `/<A\s+[^>]*HREF="([^"]*)"[^>]*>([^<]*)<\/A>/gi`
- **戻り値**: `SimpleBookmarkItem[]`配列

### 5.2. 検索入力欄変更時

#### フィルタリング条件
- **対象フィールド**: `name`（ブックマーク名）、`url`（ブックマークURL）
- **検索方式**: 部分一致（大文字小文字区別なし）
- **リアルタイム更新**: 入力と同時にフィルタリング実行

#### フィルタリングロジック
```typescript
const filteredBookmarks = bookmarks.filter((bookmark) => {
  if (!searchQuery) return true;
  const searchLower = searchQuery.toLowerCase();
  return (
    bookmark.name.toLowerCase().includes(searchLower) ||
    bookmark.url.toLowerCase().includes(searchLower)
  );
});
```

### 5.3. 表示中を選択ボタン押下時

#### 処理内容
- **対象**: フィルタリング後のアイテム
- **処理**: フィルタ後のIDを`selectedIds`に追加
- **実装**: `setSelectedIds(prev => new Set([...prev, ...filteredBookmarks.map(b => b.id)]))`

### 5.4. 表示中を解除ボタン押下時

#### 処理内容
- **対象**: フィルタリング後のアイテム
- **処理**: フィルタ後のIDを`selectedIds`から削除
- **実装**: `setSelectedIds(prev => new Set([...prev].filter(id => !filteredBookmarks.some(b => b.id === id))))`

### 5.5. 全て選択ボタン押下時

#### 処理内容
- **対象**: 全ブックマーク
- **処理**: 全IDで`selectedIds`を置き換え
- **実装**: `setSelectedIds(new Set(bookmarks.map(b => b.id)))`

### 5.6. 全て解除ボタン押下時

#### 処理内容
- **対象**: 全ブックマーク
- **処理**: `selectedIds`をクリア
- **実装**: `setSelectedIds(new Set())`

### 5.7. チェックボックス選択時

#### 処理内容
- **操作**: 個別アイテムのチェックボックスクリック
- **処理**: `selectedIds`のSetに対してID追加/削除
- **実装**: 
  ```typescript
  const handleToggleSelection = (id: string) => {
    setSelectedIds(prev => {
      const newSet = new Set(prev);
      if (newSet.has(id)) {
        newSet.delete(id);
      } else {
        newSet.add(id);
      }
      return newSet;
    });
  };
  ```

### 5.8. インポートボタン押下時

#### 実行条件チェック
- 選択されたブックマークが1件以上存在すること
- 0件の場合は「インポートするブックマークを選択してください」アラート表示

#### インポート処理フロー
1. **選択ブックマーク抽出**: `selectedIds`に含まれるブックマークを抽出
2. **コールバック実行**: `onImport(selectedBookmarks)`
3. **モーダル閉じる**: `handleClose()`実行

### 5.9. キャンセルボタン押下時

#### 処理内容
- **モーダル閉じる**: `handleClose()`実行
- **状態リセット**: 親コンポーネント側で状態初期化

### 5.10. 閉じるボタン押下時

#### 処理内容
- **モーダル閉じる**: `handleClose()`実行
- **状態リセット**: 親コンポーネント側で状態初期化

## 6. キーボードショートカット

| キー | 機能 | 条件 |
|------|------|------|
| Escape | モーダルを閉じる | モーダルが開いている時 |

## 7. エラーハンドリング

### 7.1. ファイル選択時エラー
- **エラー発生時**: コンソールエラー出力 + 「ブックマークファイルの読み込みに失敗しました」アラート表示
- **ローディング状態**: 必ず`finally`ブロックで解除

### 7.2. インポート時エラー
- **選択件数0**: 「インポートするブックマークを選択してください」アラート表示

## 8. データ型定義

### 8.1. SimpleBookmarkItem
```typescript
interface SimpleBookmarkItem {
  id: string;     // 一意識別子
  name: string;   // ブックマーク名
  url: string;    // ブックマークURL
}
```

### Props
```typescript
interface BookmarkImportModalProps {
  isOpen: boolean;                                    // モーダル表示状態
  onClose: () => void;                               // 閉じる時のコールバック
  onImport: (bookmarks: SimpleBookmarkItem[]) => void; // インポート実行時のコールバック
}
```

## IPC通信仕様

### selectBookmarkFile
- **呼び出し**: `window.electronAPI.selectBookmarkFile()`
- **戻り値**: `Promise<string | null>`
- **処理**: Electronのファイル選択ダイアログを表示し、選択されたファイルパスを返す

### parseBookmarkFile
- **呼び出し**: `window.electronAPI.parseBookmarkFile(filePath: string)`
- **引数**: ファイルパス
- **戻り値**: `Promise<SimpleBookmarkItem[]>`
- **処理**: HTMLファイルを解析してブックマーク情報を抽出

## スタイリング

### 主要CSSクラス
- `.modal-overlay`: モーダルオーバーレイ
- `.modal-content.bookmark-import-modal`: モーダル本体
- `.bookmark-import-controls`: コントロール部分
- `.bookmark-list-container`: ブックマークリストコンテナ
- `.bookmark-table`: ブックマークテーブル
- `.selected`: 選択行スタイル

### 列幅クラス
- `.checkbox-column`: チェックボックス列
- `.name-column`: 名前列  
- `.url-column`: URL列

## 制約事項

### 対応ファイル形式
- HTMLブックマークファイル（.html, .htm）のみ
- 他の形式（JSONなど）は非対応

### ブックマーク解析の制限
- 簡易的な正規表現ベースのパーサー
- 複雑なHTML構造には対応していない可能性
- ネストしたフォルダ構造は平坦化される

### パフォーマンス制限
- 大量のブックマーク（数千件以上）での動作は保証されていない
- 全件をメモリ上に展開するため、メモリ使用量に注意

## 使用シーン

### 典型的な使用フロー
1. 編集モードでブックマークインポートボタンクリック
2. モーダル表示
3. 「ファイルを選択」ボタンクリック
4. ブラウザのエクスポートしたHTMLファイルを選択
5. 読み込まれたブックマーク一覧を確認
6. 必要に応じて検索で絞り込み
7. インポートしたいブックマークを選択
8. 「インポート」ボタンクリック
9. 一時タブデータに追加される

### 主要ユースケース
- **ブラウザからの移行**: ChromeやFirefoxなどからエクスポートしたブックマークの取り込み
- **一括登録**: 手動登録では手間のかかる大量のブックマークの一括追加
- **選択的インポート**: 全ブックマークではなく必要な分のみを選択してインポート