# アイテム登録・編集モーダル仕様書

## 関連ドキュメント

- [画面一覧](./README.md) - 全画面構成の概要
- [メインウィンドウ](./main-window.md) - メイン画面の詳細仕様
- [管理ウィンドウ](./admin-window.md) - 管理画面の詳細仕様
- [グループ起動](../features/group-launch.md) - グループ機能の詳細
- [フォルダ取込](../features/folder-import.md) - フォルダ取込機能の詳細

## 1. 概要

アイテム登録・編集モーダル（RegisterModal）は、ランチャーに新しいアイテムを追加したり、既存アイテムを編集するためのモーダルダイアログです。単一アイテム、フォルダ取込、グループの3種類のアイテムを扱うことができます。

**キーボードショートカット**: Escapeキーでモーダルを閉じることができます（編集中の内容は破棄されます）。

### 主要機能
- **アイテム登録**: ファイル、URL、フォルダ、カスタムURIなどを新規登録
- **アイテム編集**: 既存アイテムの名前、パス、引数、保存先を変更
- **種別切り替え**: 単一アイテム、フォルダ取込、グループの3種類を選択
- **ドラッグ&ドロップ対応**: ファイルやフォルダのドロップで自動登録
- **カスタムアイコン**: アイテムごとにカスタムアイコンを設定可能
- **保存先タブ選択**: 複数タブ環境で保存先を指定

## 2. 基本情報

| 項目 | 内容 |
|------|------|
| **ファイル名** | `src/renderer/components/RegisterModal.tsx` |
| **コンポーネント名** | `RegisterModal` |
| **スタイル** | `src/renderer/styles/components/RegisterModal.css` |
| **表示条件** | 下記トリガーのいずれか |
| **モーダルタイプ** | オーバーレイ型モーダル |
| **親画面** | メインウィンドウ、管理ウィンドウ（EditModeView） |

### 表示トリガー

| トリガー | モード | 説明 |
|----------|--------|------|
| ➕ボタンクリック（メインウィンドウ） | 登録モード | 空のフォームを表示 |
| ファイル/フォルダをドラッグ&ドロップ | 登録モード | ドロップ内容で初期化 |
| ✏️ボタンクリック（管理ウィンドウ） | 編集モード | 既存アイテムで初期化 |
| コンテキストメニュー「編集」 | 編集モード | 既存アイテムで初期化 |

## 3. 画面項目一覧

| エリア | 項目名 | 内容・説明 | 表示条件 | 機能詳細 |
|--------|--------|------------|----------|----------|
| **ヘッダー** | タイトル | 登録モード:「アイテムの登録」<br>編集モード:「アイテムの編集」 | 常時表示 | - |
| **アイテムヘッダー** | アイコンプレビュー | アイテムのアイコンを表示 | アイコンがある場合 | - |
| **フォーム** | 種別ドロップダウン | 📄単一アイテム / 🗂️フォルダ取込 / 📦グループ | 常時表示 | [4.1](#41-種別を変更) |
| **フォーム** | 名前入力欄 | アイテムの表示名を入力 | 種別が単一アイテムまたはグループの場合 | [4.2](#42-名前を入力) |
| **フォーム** | パス入力欄 | ファイルパス、URL、カスタムURIを入力 | 種別が単一アイテムまたはフォルダ取込の場合 | [4.3](#43-パスを入力) |
| **フォーム** | 引数入力欄 | コマンドライン引数を入力 | 種別が単一アイテムの場合 | [4.4](#44-引数を入力) |
| **フォーム** | フォルダ取込オプション | DirOptionsEditorコンポーネント | 種別がフォルダ取込の場合 | [4.5](#45-フォルダ取込オプションを設定) |
| **フォーム** | グループアイテムリスト | 選択されたアイテム名のチップリスト | 種別がグループの場合 | [4.6](#46-グループアイテムを管理) |
| **フォーム** | 「+ アイテムを追加」ボタン | グループアイテム選択モーダルを開く | 種別がグループの場合 | [4.7](#47-グループアイテムを追加) |
| **フォーム** | 保存先タブドロップダウン | 保存先のタブを選択 | 常時表示 | [4.8](#48-保存先タブを変更) |
| **フォーム** | 保存先ファイルドロップダウン | 保存先のファイルを選択 | タブに複数ファイルがある場合 | [4.9](#49-保存先ファイルを変更) |
| **フォーム** | カスタムアイコンセクション | アイコンプレビュー、選択/削除ボタン | 種別がフォルダ取込以外の場合 | [4.10](#410-カスタムアイコンを設定) |
| **フッター** | キャンセルボタン | モーダルを閉じる | 常時表示 | [4.11](#411-キャンセルボタンをクリック) |
| **フッター** | 登録/更新ボタン | 登録モード:「登録」<br>編集モード:「更新」 | 常時表示 | [4.12](#412-登録更新ボタンをクリック) |
| **エラー表示** | エラーメッセージ | バリデーションエラーを各項目下に表示 | エラーがある場合 | - |

## 4. アクション一覧

| No | アクション名 | トリガー | 主な処理内容 | 詳細 |
|----|------------|---------|------------|------|
| 4.1 | 種別を変更 | 種別ドロップダウン変更 | フォーム項目の表示切り替え | [詳細](#41-種別を変更) |
| 4.2 | 名前を入力 | テキスト入力 | アイテム名の更新 | [詳細](#42-名前を入力) |
| 4.3 | パスを入力 | テキスト入力 | パス/URL/URIの更新、タイプ自動検出 | [詳細](#43-パスを入力) |
| 4.4 | 引数を入力 | テキスト入力 | コマンドライン引数の更新 | [詳細](#44-引数を入力) |
| 4.5 | フォルダ取込オプションを設定 | オプション変更 | dirOptionsの更新 | [詳細](#45-フォルダ取込オプションを設定) |
| 4.6 | グループアイテムを管理 | 削除ボタンクリック | グループメンバーの削除 | [詳細](#46-グループアイテムを管理) |
| 4.7 | グループアイテムを追加 | 追加ボタンクリック | 選択モーダルを開く | [詳細](#47-グループアイテムを追加) |
| 4.8 | 保存先タブを変更 | ドロップダウン変更 | 保存先タブの更新 | [詳細](#48-保存先タブを変更) |
| 4.9 | 保存先ファイルを変更 | ドロップダウン変更 | 保存先ファイルの更新 | [詳細](#49-保存先ファイルを変更) |
| 4.10 | カスタムアイコンを設定 | ファイル選択/削除 | カスタムアイコンの管理 | [詳細](#410-カスタムアイコンを設定) |
| 4.11 | キャンセルボタンをクリック | ボタンクリック | モーダルを閉じる | [詳細](#411-キャンセルボタンをクリック) |
| 4.12 | 登録/更新ボタンをクリック | ボタンクリック | バリデーションと登録/更新処理 | [詳細](#412-登録更新ボタンをクリック) |

## 5. 機能詳細

### 4.1. 種別を変更

#### アクション
- 種別ドロップダウンで「📄 単一アイテム」「🗂️ フォルダ取込」「📦 グループ」のいずれかを選択

#### 処理フロー
1. 選択した種別に応じてフォーム項目を切り替え
2. 種別固有の初期値を設定

#### 種別ごとの表示項目

| 項目 | 単一アイテム | フォルダ取込 | グループ |
|------|:-----------:|:-----------:|:--------:|
| 名前 | ○ | - | ○ |
| パス | ○ | ○ | - |
| 引数 | ○ | - | - |
| フォルダ取込オプション | - | ○ | - |
| グループアイテムリスト | - | - | ○ |
| カスタムアイコン | ○ | - | ○ |

#### 種別変更時の初期化処理

**フォルダ取込に変更時:**
```typescript
newItems[index].folderProcessing = 'expand';
newItems[index].dirOptions = {
  depth: 0,
  types: 'both',
  filter: undefined,
  exclude: undefined,
  prefix: undefined,
  suffix: undefined,
};
delete newItems[index].groupItemNames;
```

**グループに変更時:**
```typescript
newItems[index].groupItemNames = [];
delete newItems[index].folderProcessing;
delete newItems[index].dirOptions;
```

**単一アイテムに変更時:**
```typescript
delete newItems[index].folderProcessing;
delete newItems[index].dirOptions;
delete newItems[index].groupItemNames;
```

### 4.2. 名前を入力

#### アクション
- 名前入力欄にテキストを入力

#### 処理フロー
1. 入力値を取得
2. アイテムの`name`プロパティを更新
3. 入力時にエラー状態をクリア

#### プレースホルダー
- 単一アイテム: 「表示名を入力」
- グループ: 「グループ名を入力」

#### バリデーション
- **単一アイテム**: 必須（空の場合「名前を入力してください」）
- **グループ**: 必須（空の場合「グループ名を入力してください」）
- **フォルダ取込**: 不要（表示されない）

### 4.3. パスを入力

#### アクション
- パス入力欄にファイルパス、URL、カスタムURIを入力

#### 処理フロー
1. 入力値を取得
2. アイテムの`path`プロパティを更新
3. `detectItemType()`でアイテムタイプを自動検出
4. タイプに応じてデフォルト値を設定
5. 入力時にエラー状態をクリア

#### アイテムタイプの自動検出
| 入力パターン | 検出タイプ |
|-------------|-----------|
| `http://` または `https://` | `url` |
| `C:\` などのローカルパス（フォルダ） | `folder` |
| `C:\` などのローカルパス（ファイル） | `file` |
| `*.exe` ファイル | `exe` |
| `obsidian://` などカスタムURI | `custom-uri` |

#### フォルダ検出時の追加処理
```typescript
if (newType === 'folder') {
  newItems[index].folderProcessing = 'folder';
  newItems[index].dirOptions = {
    depth: 0, types: 'both',
    filter: undefined, exclude: undefined,
    prefix: undefined, suffix: undefined,
  };
}
```

#### プレースホルダー
- 「ファイルパス、URL、またはカスタムURIを入力」

#### 読み取り専用条件
- ドラッグ&ドロップで開いた場合、パスは読み取り専用（編集不可）

#### バリデーション
- **単一アイテム/フォルダ取込**: 必須（空の場合「パスを入力してください」）
- **グループ**: 不要（表示されない）

### 4.4. 引数を入力

#### アクション
- 引数入力欄にコマンドライン引数を入力

#### 処理フロー
1. 入力値を取得
2. アイテムの`args`プロパティを更新

#### プレースホルダー
- 「コマンドライン引数（実行ファイルやアプリの場合のみ有効）」

#### バリデーション
- 任意項目（バリデーションなし）

### 4.5. フォルダ取込オプションを設定

#### アクション
- DirOptionsEditorコンポーネントでオプションを編集

#### 処理フロー
1. DirOptionsEditorがオプション変更を通知
2. `handleItemChange(index, 'dirOptions', newDirOptions)`を実行
3. アイテムの`dirOptions`プロパティを更新

#### 設定可能なオプション
| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| `depth` | サブディレクトリの深さ（0=現在のみ、-1=無制限） | 0 |
| `types` | 取得タイプ（file/folder/both） | both |
| `filter` | ファイル名フィルター（例: *.txt） | なし |
| `exclude` | 除外パターン（例: temp*） | なし |
| `prefix` | 表示名プレフィックス | なし |
| `suffix` | 表示名サフィックス | なし |

#### 関連ドキュメント
- [dir-options-editor.md](./dir-options-editor.md) - フォルダ取込オプションエディタの詳細仕様

### 4.6. グループアイテムを管理

#### アクション
- グループアイテムリスト内の「×」ボタンをクリックしてアイテムを削除

#### 処理フロー
1. 削除対象のインデックスを取得
2. `handleRemoveGroupItem(itemIndex, groupItemNameIndex)`を実行
3. `groupItemNames`配列から対象を削除
4. UIを更新

#### 表示内容
- 選択されたアイテム名がチップ形式で表示
- 各チップに「×」削除ボタンを表示
- アイテムがない場合「アイテムが追加されていません」と表示

### 4.7. グループアイテムを追加

#### アクション
- 「+ アイテムを追加」ボタンをクリック

#### 処理フロー
1. 編集中のアイテムインデックスを記録
2. GroupItemSelectorModalを開く
3. ユーザーがアイテムを選択
4. `handleSelectGroupItem(itemName)`で選択アイテムを追加
5. `groupItemNames`配列に追加
6. エラー状態をクリア

#### GroupItemSelectorModalへの引数
- `targetFile`: 保存先ファイル（同じファイル内のアイテムのみ選択可能）
- `excludeNames`: 既に選択済みのアイテム名（重複選択防止）

#### 関連ドキュメント
- [group-item-selector-modal.md](./group-item-selector-modal.md) - グループアイテム選択モーダルの詳細仕様

### 4.8. 保存先タブを変更

#### アクション
- 保存先タブドロップダウンで対象タブを選択

#### 処理フロー
1. 選択したタブを取得
2. `handleTargetTabChange(index, targetTab)`を実行
3. アイテムの`targetTab`プロパティを更新
4. タブに複数ファイルがある場合、最初のファイルを`targetFile`に設定

#### 選択肢の生成
- 設定ファイルの`dataFileTabs`配列から取得
- 各タブの名前（`tab.name`）を表示
- 値は`tab.files[0]`（タブの最初のファイル）

### 4.9. 保存先ファイルを変更

#### アクション
- 保存先ファイルドロップダウンでファイルを選択

#### 表示条件
- 選択されているタブに複数のファイルがある場合のみ表示

#### 処理フロー
1. 選択したファイルを取得
2. `handleItemChange(index, 'targetFile', value)`を実行
3. アイテムの`targetFile`プロパティを更新

### 4.10. カスタムアイコンを設定

#### アクション
- 「ファイルから選択」ボタンでアイコンファイルを選択
- 「削除」ボタンでカスタムアイコンを削除

#### 処理フロー（選択時）
1. `openCustomIconPicker(index)`でFilePickerDialogを開く
2. ユーザーが画像ファイルを選択
3. `handleCustomIconFileSelected()`でアイコンを保存
4. `window.electronAPI.saveCustomIcon(filePath, itemPath)`でアイコンをコピー
5. プレビュー用にアイコンを読み込み
6. アイテムの`customIcon`プロパティを更新

#### 処理フロー（削除時）
1. `onCustomIconDeleted(index)`を実行
2. `window.electronAPI.deleteCustomIcon(customIconFileName)`でファイルを削除
3. プレビューをクリア
4. アイテムの`customIcon`プロパティをクリア

#### FilePickerDialogの設定
- タイトル: 「カスタムアイコンを選択」
- ファイルタイプ: 画像ファイル（image）
- 説明: 「アイコンとして使用する画像ファイルを選択してください。」

#### 関連ドキュメント
- [dialogs.md](./dialogs.md) - FilePickerDialogの詳細仕様

### 4.11. キャンセルボタンをクリック

#### アクション
- 「キャンセル」ボタンをクリック、またはEscapeキーを押下

#### 処理フロー
1. `handleCancel()`を実行
2. アイテム状態をクリア
3. `onClose()`コールバックを呼び出し
4. モーダルを閉じる

#### 注意
- 編集中の内容は保存されずに破棄される
- 確認ダイアログは表示されない

### 4.12. 登録/更新ボタンをクリック

#### アクション
- 「登録」または「更新」ボタンをクリック

#### バリデーション処理
1. 全アイテムに対してバリデーションを実行
2. エラーがある場合は`errors`状態を更新して処理中止

#### バリデーションルール

| 種別 | 項目 | ルール | エラーメッセージ |
|------|------|--------|-----------------|
| 単一アイテム | 名前 | 必須 | 「名前を入力してください」 |
| 単一アイテム | パス | 必須 | 「パスを入力してください」 |
| フォルダ取込 | パス | 必須 | 「パスを入力してください」 |
| グループ | 名前 | 必須 | 「グループ名を入力してください」 |
| グループ | アイテムリスト | 1件以上 | 「グループアイテムを追加してください」 |

#### 登録処理フロー
1. バリデーション成功
2. `onRegister(items)`コールバックを呼び出し
3. `onClose()`でモーダルを閉じる

## 6. 初期化処理

### モーダルオープン時の初期化

モーダルが開かれた際、状況に応じて異なる初期化処理が実行されます。

#### 編集モードの場合（editingItemあり）
1. 既存アイテムの情報をRegisterItem形式に変換
2. カスタムアイコンがある場合はプレビューを読み込み
3. 保存先タブ/ファイルを現在の設定から取得

#### ドラッグ&ドロップの場合（droppedPathsあり）
1. 各パスに対してアイテム情報を自動検出
2. アイコンを取得（存在する場合）
3. 現在のタブを保存先として設定
4. パスフィールドを読み取り専用に設定

#### 手動登録の場合（どちらもなし）
1. 空のテンプレートアイテムを1つ作成
2. 現在のタブを保存先として設定
3. デフォルト値で初期化

### ウィンドウサイズの調整

モーダル内容に応じてウィンドウサイズが動的に調整されます。

| 条件 | 幅 | 高さ |
|------|-----|------|
| フォルダ取込アイテムあり | 900px | 1000px |
| その他 | 800px | 1000px |

## 7. キーボード操作

### モーダル内のキー制御

| キー | 動作 |
|------|------|
| Escape | モーダルを閉じる（GroupItemSelectorModal表示中は除く） |
| Tab | フォーカス移動（モーダル内で循環） |
| Shift+Tab | フォーカス逆移動（モーダル内で循環） |
| 入力フィールド内の編集キー | 通常の入力操作として許可 |

### フォーカストラップ
- モーダル内でTabキーによるフォーカス移動が循環
- 最後の要素でTabを押すと最初の要素に移動
- 最初の要素でShift+Tabを押すと最後の要素に移動

## 8. 子コンポーネント

### 使用コンポーネント一覧

| コンポーネント | 用途 | 表示条件 |
|---------------|------|----------|
| `DirOptionsEditor` | フォルダ取込オプションの編集 | 種別がフォルダ取込 |
| `GroupItemSelectorModal` | グループメンバーの選択 | 追加ボタンクリック時 |
| `FilePickerDialog` | カスタムアイコンファイルの選択 | アイコン選択時 |

## 9. カスタムフック

### useRegisterForm

フォーム状態の管理を担当するカスタムフック。

**主な状態:**
- `items`: 編集中のアイテム配列
- `loading`: 読み込み中フラグ
- `errors`: バリデーションエラー
- `availableTabs`: 利用可能なタブ一覧
- `selectorModalOpen`: GroupItemSelectorModalの表示状態
- `editingItemIndex`: 編集中のアイテムインデックス

**主な関数:**
- `handleItemChange()`: アイテムの値を変更
- `validateAndRegister()`: バリデーションと登録
- `handleCancel()`: キャンセル処理
- `handleAddGroupItem()`: グループアイテム追加
- `handleSelectGroupItem()`: グループアイテム選択
- `handleRemoveGroupItem()`: グループアイテム削除
- `handleTargetTabChange()`: 保存先タブ変更

### useCustomIcon

カスタムアイコンの管理を担当するカスタムフック。

**主な状態:**
- `customIconPreviews`: アイコンプレビューのbase64データ
- `filePickerState`: FilePickerDialogの状態

**主な関数:**
- `openCustomIconPicker()`: アイコン選択ダイアログを開く
- `closeCustomIconPicker()`: ダイアログを閉じる
- `handleCustomIconFileSelected()`: ファイル選択時の処理
- `deleteCustomIcon()`: カスタムアイコンを削除
- `loadCustomIconPreview()`: プレビューを読み込み

## 10. エラーハンドリング

### バリデーションエラー

- 各入力項目の下にエラーメッセージを表示
- エラーのある入力欄には`error`クラスを適用（赤枠表示）
- 入力変更時に該当項目のエラーをクリア

### カスタムアイコンエラー

- アイコン保存失敗時: アラートを表示
- アイコン削除失敗時: アラートを表示
- エラー内容をコンソールに出力

## 11. スタイル

### 主要なCSSクラス

| クラス名 | 説明 |
|---------|------|
| `.register-modal` | モーダルコンテナ |
| `.register-items` | アイテムリストコンテナ |
| `.register-item` | 個々のアイテムフォーム |
| `.item-header` | アイテムヘッダー（アイコン表示） |
| `.form-group` | フォームグループ |
| `.custom-icon-section` | カスタムアイコンセクション |
| `.group-item-list` | グループアイテムリスト |
| `.item-chip` | グループアイテムチップ |
| `.error` | エラー状態の入力欄 |
| `.error-message` | エラーメッセージ |
| `.readonly` | 読み取り専用入力欄 |
