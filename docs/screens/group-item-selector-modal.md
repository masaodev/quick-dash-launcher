# グループアイテム選択モーダル仕様書

## 関連ドキュメント

- [画面一覧](./README.md) - 全画面構成の概要
- [アイテム登録・編集モーダル](./register-modal.md) - 親モーダル
- [グループ起動](../features/group-launch.md) - グループ機能の詳細

## 1. 概要

グループアイテム選択モーダル（GroupItemSelectorModal）は、グループアイテムに追加するメンバーを選択するためのモーダルダイアログです。同じデータファイル内の既存アイテムから選択できます。

**キーボードショートカット**: Escapeキーでモーダルを閉じることができます。

### 主要機能
- **アイテム一覧表示**: 対象ファイル内の選択可能なアイテムを一覧表示
- **検索フィルタリング**: アイテム名でリアルタイム検索
- **除外表示**: 既に追加済みのアイテムを選択不可として表示
- **アイコン表示**: 各アイテムのアイコンを表示

## 2. 基本情報

| 項目 | 内容 |
|------|------|
| **ファイル名** | `src/renderer/components/GroupItemSelectorModal.tsx` |
| **コンポーネント名** | `GroupItemSelectorModal` |
| **表示条件** | RegisterModalでグループアイテムの「+ アイテムを追加」ボタンをクリック |
| **モーダルタイプ** | オーバーレイ型モーダル |
| **親画面** | RegisterModal |

## 3. Props

| プロパティ | 型 | 必須 | 説明 |
|-----------|------|:----:|------|
| `isOpen` | `boolean` | ○ | モーダルの表示状態 |
| `onClose` | `() => void` | ○ | 閉じる時のコールバック |
| `onSelect` | `(itemName: string) => void` | ○ | アイテム選択時のコールバック |
| `targetFile` | `string` | ○ | 対象のデータファイル名（例: `data.txt`） |
| `excludeNames` | `string[]` | ○ | 既に追加済みのアイテム名（選択不可にする） |

## 4. 画面項目一覧

| エリア | 項目名 | 内容・説明 | 表示条件 | 機能詳細 |
|--------|--------|------------|----------|----------|
| **ヘッダー** | タイトル | 「グループアイテムを選択」 | 常時表示 | - |
| **検索** | 検索入力欄 | アイテム名で検索 | 常時表示 | [4.1](#41-検索入力欄に文字入力) |
| **リスト** | アイテム一覧 | 選択可能なアイテムのリスト | 常時表示 | [4.2](#42-アイテムをクリック) |
| **リスト** | アイテム行（通常） | 選択可能なアイテム | 未追加のアイテム | [4.2](#42-アイテムをクリック) |
| **リスト** | アイテム行（除外） | 選択不可のアイテム | 追加済みのアイテム | - |
| **リスト** | アイコン | アイテムのアイコンまたはデフォルト絵文字 | 各アイテム | - |
| **リスト** | アイテム名 | アイテムの表示名 | 各アイテム | - |
| **リスト** | 追加済みラベル | 「追加済み」の表示 | 追加済みのアイテム | - |
| **リスト** | 空リストメッセージ | 「このファイルにはアイテムがありません」または「検索結果がありません」 | アイテムが0件の場合 | - |
| **フッター** | キャンセルボタン | モーダルを閉じる | 常時表示 | [4.3](#43-キャンセルボタンをクリック) |

## 5. アクション一覧

| No | アクション名 | トリガー | 主な処理内容 | 詳細 |
|----|------------|---------|------------|------|
| 4.1 | 検索入力欄に文字入力 | テキスト入力 | アイテムのフィルタリング | [詳細](#41-検索入力欄に文字入力) |
| 4.2 | アイテムをクリック | 行クリック | アイテムを選択して閉じる | [詳細](#42-アイテムをクリック) |
| 4.3 | キャンセルボタンをクリック | ボタンクリック | モーダルを閉じる | [詳細](#43-キャンセルボタンをクリック) |

## 6. 機能詳細

### 4.1. 検索入力欄に文字入力

#### アクション
- 検索入力欄にテキストを入力

#### 処理フロー
1. 入力値を取得
2. 入力値が空の場合、全アイテムを表示
3. 入力値がある場合、アイテム名で部分一致フィルタリング
4. フィルタリング結果を表示

#### フィルタリングロジック
```typescript
const filtered = availableItems.filter((item) =>
  item.name.toLowerCase().includes(query.toLowerCase())
);
```

#### プレースホルダー
- 「アイテム名で検索...」

### 4.2. アイテムをクリック

#### アクション
- アイテム一覧の行をクリック

#### 実行条件
- アイテムが`excludeNames`に含まれていないこと

#### 処理フロー
1. クリックしたアイテムが選択可能かチェック
2. 選択可能な場合：
   - `onSelect(itemName)`コールバックを実行
   - `onClose()`でモーダルを閉じる
3. 選択不可（追加済み）の場合：
   - 何も実行しない

### 4.3. キャンセルボタンをクリック

#### アクション
- 「キャンセル」ボタンをクリック、またはEscapeキーを押下、またはオーバーレイをクリック

#### 処理フロー
1. `onClose()`コールバックを実行
2. モーダルを閉じる

## 7. 初期化処理

### モーダルオープン時の処理

1. 検索クエリをクリア
2. `loadAvailableItems()`でアイテム一覧を読み込み
3. フォーカスをモーダルに設定
4. 検索ボックスにフォーカス移動

### アイテム読み込み処理

```typescript
const loadAvailableItems = async () => {
  const allItems = await window.electronAPI.loadDataFiles();

  // 対象ファイルのアイテムのみ抽出
  const itemsInFile = allItems.filter((item) => {
    // グループアイテムは除外
    if (item.type === 'group') return false;
    // フォルダ取込から展開されたアイテムは除外
    if (item.isDirExpanded) return false;
    // 対象ファイルのアイテムのみ
    return item.sourceFile === targetFile;
  });

  // アイコンを読み込み
  const iconCache = await window.electronAPI.loadCachedIcons(itemsInFile);
  // ...
};
```

### 除外対象

グループに追加できないアイテム:
- グループアイテム（`type === 'group'`）
- フォルダ取込から展開されたアイテム（`isDirExpanded === true`）

## 8. デフォルトアイコン

アイコンが設定されていないアイテムには、タイプに応じたデフォルト絵文字が表示されます。

| アイテムタイプ | デフォルトアイコン |
|---------------|-------------------|
| `url` | 🌐 |
| `folder` | 📁 |
| `app` | ⚙️ |
| `file` | 📄 |
| `customUri` | 🔗 |
| その他 | ❓ |

## 9. キーボード操作

| キー | 動作 |
|------|------|
| Escape | モーダルを閉じる |
| 入力フィールド内の編集キー | 通常の入力操作として許可 |

### フォーカス管理
- モーダル表示時、検索ボックスに自動フォーカス
- モーダル内のキーイベントは背景に伝播しない

## 10. スタイル

### 主要なCSSクラス

| クラス名 | 説明 |
|---------|------|
| `.group-item-selector-modal` | モーダルコンテナ |
| `.search-box` | 検索入力エリア |
| `.item-list` | アイテム一覧コンテナ |
| `.item-row` | アイテム行 |
| `.item-row.excluded` | 選択不可のアイテム行 |
| `.item-icon` | アイコン表示エリア |
| `.item-name` | アイテム名表示エリア |
| `.excluded-label` | 「追加済み」ラベル |
| `.no-items` | 空リストメッセージ |

### 除外アイテムの表示

追加済みのアイテムは視覚的に区別されます:
- 行に`excluded`クラスが適用
- クリック不可
- 「追加済み」ラベルが右端に表示

## 11. エラーハンドリング

### アイテム読み込みエラー
```typescript
try {
  // アイテム読み込み処理
} catch (error) {
  console.error('Error loading available items:', error);
}
```

- エラー時はコンソールにログ出力
- UIへのエラー表示は現在未実装
