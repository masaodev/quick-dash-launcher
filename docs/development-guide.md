# 開発ガイド

## 重要な実装詳細

### ウィンドウの動作
- フレームレスウィンドウ（479x506px）常に最前面
- DevToolsが開いていない限りブラー時に非表示（固定化時・編集モード時は例外）
- Ctrl+Alt+Wグローバルホットキーで表示/非表示
- 表示時に検索ボックスが自動クリア＆フォーカス
- 📌ボタンでウィンドウ固定化可能（固定中はフォーカスアウトしても非表示にならない）
- 編集モード時のウィンドウ自動拡大（1000x700px）と復元機能

### データファイル形式
```
// コメント行は//で開始
表示名,URLまたはパス
アプリ名,C:\path\to\app.exe,オプション引数
dir,C:\folder\path  // フォルダからファイル・フォルダをインポート
アプリ名,C:\path\to\shortcut.lnk  // 直接指定されたショートカットも自動解析
```

### アイテムタイプの検出
- URL: `://`を含む
- カスタムURI: 非http(s)スキーマ（obsidian://, ms-excel://）
- アプリ: .exe, .bat, .cmd, .com, .lnk拡張子
- フォルダ: 拡張子なしまたはスラッシュで終わる
- ファイル: その他すべて

### 検索の実装
- 大文字小文字を区別しないインクリメンタルサーチ
- スペース区切りキーワードでAND検索
- 表示名のみでフィルタリング

### 生データ編集機能
Ctrl+Eで編集モードに切り替えて、データファイル（data.txt、data2.txt、tempdata.txt）を直接編集できます。

#### 編集モードの特徴
- DIRディレクティブを展開せずに生データのまま編集
- テーブル形式で行ごとに表示・編集（☑️ | # | 種類 | 名称 | 内容 | 操作）
- **2つの編集方法を提供**:
  - **セル編集（📝）**: セルクリックまたは📝ボタンで素早い修正
  - **詳細編集（✏️）**: ✏️ボタンでRegisterModalを使った包括的編集
  - **ユーザー選択式アイテム種別**: 従来の自動判定に代わり、ユーザーが「アイテム」「DIR」を明示的に選択
  - **アイテム種別の変更**: 既存アイテムをDIRディレクティブに変更、またはその逆も可能
  - **DIR選択時の制限**: 名前フィールドは読み取り専用（ハイフン表示）、パスとDIRオプションのみ編集可能
- **アイテム表示名の個別編集**: 通常アイテムの名前のみ編集可能
- **DIRディレクティブの制限**: 名前列は編集不可、パスと引数列は編集可能
- 行の追加、削除、内容編集が可能
- リアルタイム検索による行のフィルタリング
- 変更の一時保存と一括保存機能（全ての変更は保存ボタンクリックまで確定されない）
- ヘッダーに編集中のファイル名を表示
- **ウィンドウサイズ自動拡大**: 編集モード時に1000x700pxに拡大、終了時に元のサイズに復元
- **フォーカスアウト無効化**: 編集モード中はフォーカスアウトでもウィンドウが非表示にならない

#### 技術実装
- **RawDataLine型**: 生データ行を表現する新しいデータ型
- **loadRawDataFiles/saveRawDataFiles**: 生データの読み込み・保存API
- **EditableRawItemList**: 編集可能テーブルコンポーネント
  - `onEditClick`プロパティで詳細編集機能を実装
  - セル編集と詳細編集の2つの編集方法を並行提供
- **EditModeView**: 編集モード専用のビューコンポーネント
  - RegisterModalの状態管理（`isRegisterModalOpen`, `editingItem`）
  - RawDataLine ⇔ RegisterItem の相互変換処理
  - **workingLines状態**: 編集中の一時的なデータを保持（削除・追加・編集を即座に反映せずに管理）
  - **全件書き戻し方式**: 保存時にworkingLines全体をファイルに書き込み
- **RegisterModal**: 通常モードと編集モードの両方に対応
  - `editingItem`プロパティで編集モード判定
  - 既存アイテムの事前入力機能
  - **itemCategoryプロパティ**: 'item' | 'dir' でアイテム種別を管理
  - **条件付きUI表示**: DIR選択時のみDIRオプション表示、名前フィールド制御
  - **動的種別変更**: アイテム種別変更時の自動フィールド初期化・クリア

#### 操作方法
- **セル編集**: セルをクリックまたは📝ボタンで即座に編集
- **詳細編集**: ✏️ボタンでRegisterModalを開いて包括的編集
  - **アイテム種別選択**: 画面上部でユーザーが「アイテム」「DIR」を明示的に選択
  - **アイテム選択時**: 通常のアイテム登録（名前・パス・引数の編集が可能）
  - **DIR選択時**: DIRディレクティブとして処理
    - 名前フィールドは読み取り専用（ハイフン表示）
    - DIRオプション詳細設定（深度、タイプ、フィルター、除外、プレフィックス）
  - **種別変更**: 既存アイテムとDIRディレクティブの相互変換が可能
- **名前編集**: 通常アイテムの名前列をクリック（DIRディレクティブは編集不可）
- **編集確定**: Enter または フォーカス移動
- **編集キャンセル**: Escape
- **行削除**: 選択後にDeleteキーまたは削除ボタン
- **一括操作**: チェックボックスによる複数選択
- **保存**: Ctrl+S または保存ボタン

#### テーブル構成
- **☑️**: 行選択チェックボックス
- **#**: 行番号
- **種類**: アイテムタイプ（DIR/アイテム/コメント/空行）
- **名前**: アイテムの表示名（通常アイテムのみ編集可能）
- **パスと引数**: パスと引数の統合表示（全てのタイプで編集可能）
- **操作**: 3つのボタン
  - **📝**: セル編集ボタン（素早い修正）
  - **✏️**: 詳細編集ボタン（RegisterModal使用）
  - **🗑️**: 削除ボタン

## ビルドシステム

Viteベースのビルドシステムを使用:
- **メインプロセス**: CommonJS形式で`dist/main/`に出力
- **プリロードスクリプト**: CommonJS形式で`dist/preload/`に出力
- **レンダラープロセス**: 標準的なViteビルドで`dist/renderer/`に出力
- **開発サーバー**: ポート9000で実行

## コード品質向上のガイドライン

### リファクタリングの原則
1. **DRY（Don't Repeat Yourself）**: 同じロジックの重複を避ける
2. **単一責任の原則**: 1つの関数は1つの責任のみ持つ
3. **関数の小型化**: 理解しやすいサイズに関数を分割
4. **命名の明確化**: 関数名と変数名で処理内容を明確に表現

### 共通処理の抽出手順
1. **重複コードの特定**: 同様の処理が複数箇所にないか定期的に確認
2. **共通部分の抽出**: 重複している処理を独立した関数として分離
3. **関数の統合**: 抽出した共通関数を各箇所で使用するよう修正
4. **動作確認**: ビルドとテストで機能が維持されることを検証

### パフォーマンス最適化
- **バンドルサイズ**: 不要なコードの削除でアプリケーションサイズを最適化
- **処理の一貫性**: 同じデータに対して常に同じ処理を適用
- **エラーハンドリング**: 1箇所での修正が全体に反映される設計

## UIコンポーネント構造

### 主要コンポーネント
- **App.tsx**: メインアプリケーションコンポーネント
- **SearchBox.tsx**: 検索入力フィールド
- **ActionButtons.tsx**: アクションボタンコンテナ
- **SettingsDropdown.tsx**: 設定関連機能のドロップダウンメニュー
- **TabControl.tsx**: メイン/一時タブの切り替え
- **ItemList.tsx**: アイテムリスト表示
- **RegisterModal.tsx**: ドラッグ&ドロップ登録用モーダル
- **EditableRawItemList.tsx**: 編集モード用のデータ編集テーブル
  - パスと引数列でパス＋引数を統合表示・編集
  - アイテム行：パス＋引数の組み合わせ（例：`notepad.exe`, `https://github.com/`）
  - DIRディレクティブ：フォルダパス＋オプション（例：`C:\Users\Documents filter:*.txt`）
  - 編集時の自動CSV形式変換機能

### 設定メニュー
設定関連機能は⚙ボタンクリックで表示されるドロップダウンメニューに集約:
- 📁 設定フォルダを開く
- 📄 設定ファイルを開く
- 📋 JSON出力（クリップボードにコピー）
- 🔤 データファイルを並べ替え（パスの昇順でソート）
- ─── (区切り線)
- 🚪 アプリを終了

## 現在の制限事項とTODO

1. **最小限のエラーハンドリング** - エラーはコンソールにのみログ出力
2. **Windows専用パス** - クロスプラットフォーム非対応
3. **テストフレームワーク未導入** - 手動テストのみ

## デバッグ時の問題

### 白い/空白のウィンドウ
- DevToolsコンソールでエラーを確認（自動的に開く）
- Viteデベロップメントサーバーが起動しているか確認（開発モード時）
- プロダクションモードでindex.htmlパスが正しいか確認

### よくあるビルドの問題
- TypeScript設定の`@common`パスエイリアスがVite設定と一致しているか確認
- ビルド出力が正しいディレクトリ構造になっているか確認
- Electronのファイルパスがビルド/開発モードで適切に処理されているか確認

## テストチェックリスト

1. グローバルホットキー（Ctrl+Alt+W）登録とウィンドウトグル
2. 全キーボードショートカット（Enter、Shift+Enter、矢印、Ctrl、Escape）
3. 単一および複数キーワードでの検索
4. メイン/一時タブの切り替え
5. 異なるアイテムタイプの起動（URL、ファイル、フォルダ、引数付きアプリ）
6. ウェブサイトのファビコン一括取得（🌐ボタン）
7. アプリケーションアイコンの一括抽出（🎨ボタン、URLを除く） 
8. カスタムURIアイコンの一括抽出（🎨ボタン）
   - obsidian://, ms-excel://, vscode://等のカスタムURIでレジストリベースのアイコン取得
   - キャッシュ機能（uri_[スキーマ]_icon.png形式）
   - フォールバック機能（レジストリ → 拡張子 → デフォルト絵文字）
9. 一時タブへのアイテム追加
10. システムトレイダブルクリックでの復元
11. URIスキーマ（obsidian://, ms-excel://など）の処理
12. ウィンドウ固定化機能（📌ボタン）
    - 固定ボタンクリックで固定/固定解除の切り替え
    - 固定中はフォーカスアウトしても非表示にならない
    - 固定状態の視覚的フィードバック（ボタンの色変化）
    - アプリケーション再起動時の状態保持（初期状態は非固定）
13. ショートカット処理の統一性
    - dirディレクティブと直接指定の.lnkファイルが同じ処理を受ける
    - 引数を含む複雑なショートカットの正常な解析
    - ターゲットパスの正確な抽出とアイテムタイプの適切な分類
14. ドラッグ&ドロップ登録機能
    - ファイルやフォルダをウィンドウにドラッグするとオーバーレイ表示
    - 複数ファイルの同時ドロップに対応
    - 登録モーダルでアイテム名、保存先タブ、引数を設定可能
    - フォルダは「フォルダ自体」または「内容を展開」を選択可能
    - アイコンの自動抽出と表示
15. 設定メニューによる各種操作（⚙ボタン）
    - 設定フォルダ・ファイルへのアクセス
    - JSON形式でのデータエクスポート
    - データファイルの並べ替え（パスの昇順）
    - アプリケーションの終了
16. データファイルの並べ替え機能
    - data.txt、data2.txt、tempdata.txtをパスの昇順でソート
    - ソート前にbackupフォルダへ自動バックアップ（タイムスタンプ付き）
    - dirディレクティブ行はファイル先頭に維持
    - CSV形式の適切な解析（カンマや引用符を含むパスに対応）
17. 拡張DIRディレクティブ機能
    - 基本構文: `dir,パス[,オプション...]`
    - 対応オプション:
      - `depth=数値`: サブディレクトリを辿る深さ（0=現在のみ、-1=無制限）
      - `types=file|folder|both`: 取得するタイプ（デフォルト: both）
      - `filter=パターン`: ファイル/フォルダー名のフィルター（例: *.txt）
      - `exclude=パターン`: 除外パターン（例: temp*）
      - `prefix=文字列`: 展開されるアイテムの表示名に付けるプレフィックス
    - 後方互換性: オプションなしの場合は従来通り.lnkファイルのみ
    - 使用例:
      - `dir,C:\Users\Desktop,types=file,filter=*.exe`
      - `dir,C:\Users\Desktop,depth=2,types=folder`
      - `dir,C:\Users\Desktop,depth=1,filter=*.txt,exclude=temp*`
      - `dir,C:\Projects,prefix=仕事,depth=1,types=file`（「仕事: ファイル名」として表示）

## ファイル入出力処理

### 改行コードの処理
- **ファイル保存時**: 常にCRLF（`\r\n`）で統一
- **ファイル読み込み時**: 正規表現`/\r\n|\n|\r/`で分割し、CRLF、LF、CRのいずれにも対応
- **対象関数**:
  - `loadRawDataFiles`: 生データファイルの読み込み
  - `saveRawDataFiles`: 生データファイルの保存（CRLF統一）
  - `loadDataFiles`: DIRディレクティブ展開時の読み込み
  - `sortDataFiles`: ファイルソート時の読み込み・保存
  - `registerItems`: 新規アイテム登録時の保存

### CSVフォーマットの処理
- **アイテム行**: `名前,パス[,引数][,元パス]`
  - 引数と元パスは省略可能
  - セル編集時は必要なフィールドのみ出力（末尾の無駄なカンマを防止）
- **DIRディレクティブ**: `dir,パス[,オプション...]`
  - オプションはカンマ区切りで複数指定可能