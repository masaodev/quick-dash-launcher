# 開発ガイド

## 重要な実装詳細

### ウィンドウの動作
- フレームレスウィンドウ（479x506px）常に最前面
- DevToolsが開いていない限りブラー時に非表示（固定化時は例外）
- Ctrl+Alt+Wグローバルホットキーで表示/非表示
- 表示時に検索ボックスが自動クリア＆フォーカス
- 📌ボタンでウィンドウ固定化可能（固定中はフォーカスアウトしても非表示にならない）

### データファイル形式
```
// コメント行は//で開始
表示名,URLまたはパス
アプリ名,C:\path\to\app.exe,オプション引数
dir,C:\folder\path  // フォルダからファイル・フォルダをインポート
アプリ名,C:\path\to\shortcut.lnk  // 直接指定されたショートカットも自動解析
```

### アイテムタイプの検出
- URL: `://`を含む
- カスタムURI: 非http(s)スキーマ（obsidian://, ms-excel://）
- アプリ: .exe, .bat, .cmd, .com, .lnk拡張子
- フォルダ: 拡張子なしまたはスラッシュで終わる
- ファイル: その他すべて

### 検索の実装
- 大文字小文字を区別しないインクリメンタルサーチ
- スペース区切りキーワードでAND検索
- 表示名のみでフィルタリング

### 生データ編集機能
Ctrl+Eで編集モードに切り替えて、データファイル（data.txt、data2.txt、tempdata.txt）を直接編集できます。

#### 編集モードの特徴
- DIRディレクティブを展開せずに生データのまま編集
- テーブル形式で行ごとに表示・編集（☑️ | # | 種類 | 名称 | 内容 | 操作）
- **アイテム表示名の個別編集**: 通常アイテムの名称のみ編集可能
- **DIRディレクティブの制限**: 名称列は編集不可、内容列は編集可能
- 行の追加、削除、内容編集が可能
- リアルタイム検索による行のフィルタリング
- 変更の一時保存と一括保存機能
- ヘッダーに編集中のファイル名を表示

#### 技術実装
- **RawDataLine型**: 生データ行を表現する新しいデータ型
- **loadRawDataFiles/saveRawDataFiles**: 生データの読み込み・保存API
- **EditableRawItemList**: 編集可能テーブルコンポーネント
- **EditModeView**: 編集モード専用のビューコンポーネント

#### 操作方法
- **編集開始**: セルをクリックまたは編集ボタン
- **名称編集**: 通常アイテムの名称列をクリック（DIRディレクティブは編集不可）
- **編集確定**: Enter または フォーカス移動
- **編集キャンセル**: Escape
- **行削除**: 選択後にDeleteキーまたは削除ボタン
- **一括操作**: チェックボックスによる複数選択
- **保存**: Ctrl+S または保存ボタン

#### テーブル構成
- **☑️**: 行選択チェックボックス
- **#**: 行番号
- **種類**: アイテムタイプ（DIR/アイテム/コメント/空行）
- **名称**: アイテムの表示名（通常アイテムのみ編集可能）
- **内容**: 行の実際のデータ（全てのタイプで編集可能）
- **操作**: 編集・削除ボタン

## ビルドシステム

Viteベースのビルドシステムを使用:
- **メインプロセス**: CommonJS形式で`dist/main/`に出力
- **プリロードスクリプト**: CommonJS形式で`dist/preload/`に出力
- **レンダラープロセス**: 標準的なViteビルドで`dist/renderer/`に出力
- **開発サーバー**: ポート9000で実行

## コード品質向上のガイドライン

### リファクタリングの原則
1. **DRY（Don't Repeat Yourself）**: 同じロジックの重複を避ける
2. **単一責任の原則**: 1つの関数は1つの責任のみ持つ
3. **関数の小型化**: 理解しやすいサイズに関数を分割
4. **命名の明確化**: 関数名と変数名で処理内容を明確に表現

### 共通処理の抽出手順
1. **重複コードの特定**: 同様の処理が複数箇所にないか定期的に確認
2. **共通部分の抽出**: 重複している処理を独立した関数として分離
3. **関数の統合**: 抽出した共通関数を各箇所で使用するよう修正
4. **動作確認**: ビルドとテストで機能が維持されることを検証

### パフォーマンス最適化
- **バンドルサイズ**: 不要なコードの削除でアプリケーションサイズを最適化
- **処理の一貫性**: 同じデータに対して常に同じ処理を適用
- **エラーハンドリング**: 1箇所での修正が全体に反映される設計

## UIコンポーネント構造

### 主要コンポーネント
- **App.tsx**: メインアプリケーションコンポーネント
- **SearchBox.tsx**: 検索入力フィールド
- **ActionButtons.tsx**: アクションボタンコンテナ
- **SettingsDropdown.tsx**: 設定関連機能のドロップダウンメニュー
- **TabControl.tsx**: メイン/一時タブの切り替え
- **ItemList.tsx**: アイテムリスト表示
- **RegisterModal.tsx**: ドラッグ&ドロップ登録用モーダル

### 設定メニュー
設定関連機能は⚙ボタンクリックで表示されるドロップダウンメニューに集約:
- 📁 設定フォルダを開く
- 📄 設定ファイルを開く
- 📋 JSON出力（クリップボードにコピー）
- 🔤 データファイルを並べ替え（パスの昇順でソート）
- ─── (区切り線)
- 🚪 アプリを終了

## 現在の制限事項とTODO

1. **最小限のエラーハンドリング** - エラーはコンソールにのみログ出力
2. **Windows専用パス** - クロスプラットフォーム非対応
3. **テストフレームワーク未導入** - 手動テストのみ

## デバッグ時の問題

### 白い/空白のウィンドウ
- DevToolsコンソールでエラーを確認（自動的に開く）
- Viteデベロップメントサーバーが起動しているか確認（開発モード時）
- プロダクションモードでindex.htmlパスが正しいか確認

### よくあるビルドの問題
- TypeScript設定の`@common`パスエイリアスがVite設定と一致しているか確認
- ビルド出力が正しいディレクトリ構造になっているか確認
- Electronのファイルパスがビルド/開発モードで適切に処理されているか確認

## テストチェックリスト

1. グローバルホットキー（Ctrl+Alt+W）登録とウィンドウトグル
2. 全キーボードショートカット（Enter、Shift+Enter、矢印、Ctrl、Escape）
3. 単一および複数キーワードでの検索
4. メイン/一時タブの切り替え
5. 異なるアイテムタイプの起動（URL、ファイル、フォルダ、引数付きアプリ）
6. ウェブサイトのファビコン一括取得（🌐ボタン）
7. アプリケーションアイコンの一括抽出（🎨ボタン、URLを除く） 
8. カスタムURIアイコンの一括抽出（🎨ボタン）
   - obsidian://, ms-excel://, vscode://等のカスタムURIでレジストリベースのアイコン取得
   - キャッシュ機能（uri_[スキーマ]_icon.png形式）
   - フォールバック機能（レジストリ → 拡張子 → デフォルト絵文字）
9. 一時タブへのアイテム追加
10. システムトレイダブルクリックでの復元
11. URIスキーマ（obsidian://, ms-excel://など）の処理
12. ウィンドウ固定化機能（📌ボタン）
    - 固定ボタンクリックで固定/固定解除の切り替え
    - 固定中はフォーカスアウトしても非表示にならない
    - 固定状態の視覚的フィードバック（ボタンの色変化）
    - アプリケーション再起動時の状態保持（初期状態は非固定）
13. ショートカット処理の統一性
    - dirディレクティブと直接指定の.lnkファイルが同じ処理を受ける
    - 引数を含む複雑なショートカットの正常な解析
    - ターゲットパスの正確な抽出とアイテムタイプの適切な分類
14. ドラッグ&ドロップ登録機能
    - ファイルやフォルダをウィンドウにドラッグするとオーバーレイ表示
    - 複数ファイルの同時ドロップに対応
    - 登録モーダルでアイテム名、保存先タブ、引数を設定可能
    - フォルダは「フォルダ自体」または「内容を展開」を選択可能
    - アイコンの自動抽出と表示
15. 設定メニューによる各種操作（⚙ボタン）
    - 設定フォルダ・ファイルへのアクセス
    - JSON形式でのデータエクスポート
    - データファイルの並べ替え（パスの昇順）
    - アプリケーションの終了
16. データファイルの並べ替え機能
    - data.txt、data2.txt、tempdata.txtをパスの昇順でソート
    - ソート前にbackupフォルダへ自動バックアップ（タイムスタンプ付き）
    - dirディレクティブ行はファイル先頭に維持
    - CSV形式の適切な解析（カンマや引用符を含むパスに対応）
17. 拡張DIRディレクティブ機能
    - 基本構文: `dir,パス[,オプション...]`
    - 対応オプション:
      - `depth=数値`: サブディレクトリを辿る深さ（0=現在のみ、-1=無制限）
      - `types=file|folder|both`: 取得するタイプ（デフォルト: both）
      - `filter=パターン`: ファイル/フォルダー名のフィルター（例: *.txt）
      - `exclude=パターン`: 除外パターン（例: temp*）
      - `prefix=文字列`: 展開されるアイテムの表示名に付けるプレフィックス
    - 後方互換性: オプションなしの場合は従来通り.lnkファイルのみ
    - 使用例:
      - `dir,C:\Users\Desktop,types=file,filter=*.exe`
      - `dir,C:\Users\Desktop,depth=2,types=folder`
      - `dir,C:\Users\Desktop,depth=1,filter=*.txt,exclude=temp*`
      - `dir,C:\Projects,prefix=仕事,depth=1,types=file`（「仕事: ファイル名」として表示）