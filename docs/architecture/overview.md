# システム概要

QuickDashLauncherのアーキテクチャ概要とデータフローを説明します。

## プロセス構造

| プロセス | 場所 | 役割 |
|---------|------|------|
| **メインプロセス** | `src/main/main.ts` | システム操作、ウィンドウ管理、IPC処理 |
| **レンダラープロセス** | `src/renderer/` | UIのためのReactアプリケーション |
| **プリロードスクリプト** | `src/main/preload.ts` | レンダラーに限定的なAPIを公開するセキュアブリッジ |
| **共通型定義** | `src/common/types.ts` | プロセス間で共有される型定義 |

---

## サービスクラス構造

アプリケーションの主要機能は`src/main/services/`のサービスクラスで実装：

| サービス | 役割 |
|---------|------|
| `SettingsService` | アプリケーション設定の読み書き・管理 |
| `HotkeyService` | グローバルホットキーの登録・変更 |
| `BackupService` | データファイルの自動バックアップ |
| `AutoLaunchService` | Windows起動時の自動起動設定 |
| `FaviconService` | ファビコン・アイコンの取得・キャッシュ管理 |
| `SearchHistoryService` | 検索履歴の保存・読み込み |
| `WorkspaceService` | ワークスペースアイテム・グループ・実行履歴の管理 |

すべてシングルトンパターンで実装され、`getInstance()`で取得します。

---

## IPCハンドラー構造

IPCハンドラーは機能ごとに分離（`src/main/ipc/`）:

| ハンドラー | 役割 |
|-----------|------|
| `settingsHandlers.ts` | 設定の取得・更新・ホットキー変更 |
| `configHandlers.ts` | 設定フォルダーへのアクセス・外部URL開く |
| `dataHandlers.ts` | データファイルの読み込み・保存・ブックマーク解析 |
| `itemHandlers.ts` | アイテムの起動・フォルダー表示・グループ実行 |
| `iconHandlers.ts` | ファビコン取得・アイコン抽出・カスタムアイコン管理 |
| `windowHandlers.ts` | ウィンドウ固定化・編集モード・モーダルモード制御 |
| `historyHandlers.ts` | 検索履歴の読み書き |
| `editHandlers.ts` | アイテム編集（更新・削除・一括更新） |
| `splashHandlers.ts` | スプラッシュウィンドウ制御 |
| `workspaceHandlers.ts` | ワークスペースアイテム・グループ・実行履歴の操作 |

詳細は[IPCチャンネル](ipc-channels.md)を参照。

---

## データ処理システム

### 設計原則

- **一元化された処理**: 同種のデータは共通の処理関数で統一的に処理
- **拡張可能性**: 新しいファイル形式やデータソースを容易に追加可能
- **エラー処理**: 単一アイテム処理エラーがシステム全体に影響しない設計

### 処理パターン

| パターン | 説明 |
|---------|------|
| ディレクトリベース | `dir,パス`形式でディレクトリ内容を動的に取得 |
| ファイル変換 | 特定の拡張子ファイルを実行可能な形式に自動変換 |
| 直接指定 | 明示的に指定されたパスをそのまま使用 |

### データ変換の仕組み

- **入力**: 多様な形式（ディレクトリパス、ショートカットファイル、実行ファイル等）
- **処理**: ファイル種別に応じた適切な解析・変換処理
- **出力**: 統一されたCSV形式（`名前,パス,引数,カスタムアイコン`）

---

## データフロー

### 初回起動フロー

1. アプリケーション起動時に`hotkey`設定の有無をチェック
2. `hotkey`が空 → 初回設定画面を表示
3. ユーザーがホットキーを設定 → 設定保存 → メインウィンドウに遷移

### 通常モード（表示・起動）

1. メインプロセスが`%APPDATA%/quickdashlauncher/config/`からデータファイルを読み込む
2. 特殊形式を自動変換（`dir,`フォルダ取込、`.lnk`ショートカット等）
3. パーサーがマージ・重複削除・ソート
4. レンダラーがリアルタイムフィルタリングで表示
5. ユーザーアクションがIPCコールをトリガー

### 編集モード（生データ編集）

1. 編集モード開始時にウィンドウサイズを自動拡大
2. `load-raw-data-files`でデータファイルを展開せずに読み込み
3. `EditableRawItemList`コンポーネントでテーブル形式表示
4. ユーザーが行の追加・削除・編集を実行
5. `save-raw-data-files`で変更内容をファイルに書き込み
6. `data-changed`イベントでメインウィンドウに自動反映

### 設定の即座反映フロー（v1.0.0以降）

1. ユーザーが設定を変更
2. `settings:set-multiple` IPCで設定保存
3. `settings-changed`イベントを全ウィンドウに送信
4. 各ウィンドウが設定を再読み込みして画面に反映

### アイコン取得フロー

1. 🔄メニューから「🎨 アイコン取得」を選択
2. `fetchIconsCombined` IPCで統合API呼び出し
3. **フェーズ1**: ファビコン取得（URL型アイテム）
4. **フェーズ2**: アイコン抽出（EXE、カスタムURI等）
5. 進捗イベントでリアルタイム表示
6. 完了後3秒で進捗バー自動非表示

### コマンドヒストリー機能

1. 検索実行時にクエリを`history.csv`に保存（最大100件）
2. Ctrl+↑/↓キーで履歴ナビゲート
3. 重複クエリは最新時刻で更新

### ワークスペースフロー

1. `Ctrl+Alt+W`でワークスペースウィンドウを表示
2. メイン画面のアイテムを右クリック → 「ワークスペースに追加」
3. `WorkspaceService`がアイテムをworkspace.jsonに保存
4. ワークスペースウィンドウでグループ管理・名前変更・並び替え
5. アイテム起動時に実行履歴（execution-history.json）に記録（最大10件）
6. 実行履歴からワークスペースへドラッグ&ドロップでコピー可能

---

## 関連ドキュメント

- [IPCチャンネル](ipc-channels.md) - 各IPCチャンネルの仕様
- [ウィンドウ制御](window-control.md) - ウィンドウ管理システム
- [データファイル形式](data-format.md) - data.txtファイル仕様
- [CSSデザインシステム](css-design.md) - スタイル管理
